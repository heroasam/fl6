{% extends "base.html" %}

{% block title %}Articulos{% endblock %}

{% block content %}

<div x-data="main()" x-init="getArticulos()" class="container">
<p class="title is-1">Articulos</p>


<div class="block">
    <a href="/stock/asientos"  type="button" class="button is-primary">Asientos</a>
    <a href="/stock/mayor"  type="button" class="button is-primary">Mayor</a>
    <a href="/stock/pivotcuentas"  type="button" class="button is-primary">Pivot-Cuentas</a>
    <a href="/stock/retiros"  type="button" class="button is-primary">Retiros</a>
    <a href="/stock/compras"  type="button" class="button is-primary">Compras</a>
    <a href="/stock/salidas"  type="button" class="button is-primary">Salidas</a>
    <a href="/stock/verstock"  type="button" class="button is-primary">Stock</a>
    <a href="/stock/proveedores"  type="button" class="button is-primary">Proveedores</a>
    <a href="/stock/cuentas"  type="button" class="button is-primary">Cuentas</a>
</div>

<button class="button is-info mb-5" @click="generarLista()">Generar Lista de Precios</button>
<div class="block">
            <div class="field is-horizontal">
            <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
            <div class="control">
              <input type="text" x-model="newArticulo.art" class="input" placeholder="Articulo" size="25">
            </div>
            <div class="control">
              <input type="text" x-model="newArticulo.codigo" class="input" placeholder="Codigo" size="5">
            </div>
            <div class="control">
            <input list="grupos" id="grupo" class="input mb-3" x-model="newArticulo.grupo" placeholder="grupo" autocomplete="off">
                <datalist id="grupos">
                <template x-for="grupo in listagrupos">
                <option :value="grupo">
                </template>
                </datalist>
            </div>
            <div class="control">
                <input type="text" x-model="newArticulo.costo" class="input" size="5" placeholder="Costo">
            </div>
            <div class="control">
           <input type="text" x-model="newArticulo.cuota" class="input" size="5" placeholder="Cuota">
            </div>
            <div class="control">
              <input type="text" x-model="newArticulo.activo" class="input" size="5" placeholder="Activo">
            </div>
            <div class="control">
                <button type="button" class="button is-primary" @click="validarArticulo">Guardar</button>
            </div>
        </div>
</div>
<div class="columns">
<div class="column is-7">
  <table id="table" class="table is-narrow" id="table">
      <thead>
          <tr>
              <th>op</th>
              <th>op</th>
              <th>id</th>
              <th>cod</th>
              <th>art</th>
              <th>grupo</th>
              <th>costo</th>
              <th>cuota</th>
              <th>activo</th>
              <th>op</th>
          </tr>
      </thead>
      <tbody>
          <template x-for="articulo in articulos">
          <tr>
              <td><button class="button is-danger is-small" @click="borrarArticulo(articulo['id'])">Borrar</button></td>
              <td><button class="button is-info is-small" @click="editarArticulo(articulo['id'])">Editar</button></td>
              <td x-text = "articulo['id']"></td>
              <td x-text = "articulo['codigo']"></td>
              <td x-text = "articulo['art']"></td>
              <td x-text = "articulo['grupo']"></td>
              <td x-text = "articulo['costo']"></td>
              <td x-text = "articulo['cuota']"></td>
              <td><span class="tag is-success is-small" x-show="articulo['activo']">Activo</span><span class="tag is-danger is-small" x-show="!articulo['activo']">Inactivo</span></td>
              <td><button type="button" class="button is-info is-small" @click="toggleactivo(articulo['id'])">Cambiar</button></td>
          </tr>
          </template>
      </tbody>
  </table>
</div>
</div>

<div x-bind:class="verModalEdicion?'xmodal-container':''">
    <div class="xcard xmodal" x-show="verModalEdicion">
        <div class="flex justify-content-end">
            <button class="btn-close" @click="verModalEdicion=false"><i class="fa fa-times fa-2x" aria-hidden="true"></i></button>
        </div>
        <h1 class="title is-3">Edicion articulos</h1>
        <input type="text" class="input mb-1" x-model="Articulo.codigo" placeholder="codigo">
        <input type="text" class="input mb-1" x-model="Articulo.art" placeholder="articulo" style="min-width:400px;">
        <input type="text" class="input mb-1" x-model="Articulo.costo" placeholder="costo">
        <input type="text" class="input mb-1" x-model="Articulo.cuota" placeholder="cuota">
        <input list="grupos" id="grupo" class="input mb-3" x-model="Articulo.grupo" placeholder="grupo" autocomplete="off">
            <datalist id="grupos">
            <template x-for="grupo in listagrupos">
            <option :value="grupo">
            </template>
            </datalist>
        <input type="text" class="input mb-1" x-model="Articulo.activo" placeholder="activo">
        <button class="button is-primary" @click="validarEdicion">Guardar</button>
        <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
    </div>
</div>
</div>


{% endblock %}
{% block script %}
<script>
    function main(){
    return{
        Articulo:{},
        newArticulo:{art:'',cuota:'',costo:'',grupo:'',activo:'',codigo:''},
        articulos:{},
        listagrupos:[],
        art:'',
        costo:'',
        cuota:'',
        activo:'',
        verModalEdicion: false,

        getArticulos(){
            axios.get('/stock/getlistaarticulos')
            .then(res=>{
                console.log(res.data.grupos)
                this.articulos = res.data.articulos
                this.listagrupos = res.data.grupos
            })
        },
        borrarArticulo(id){
            Swal.fire({
            title: 'Â¿Esta seguro?',
            text: "El borrado es irreversible!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Si, borrarlo!'
            }).then((result) => {
            if (result.isConfirmed) {
                axios.get('/stock/deletearticulo/'+id)
                .then(res=>{
                    Swal.fire(
                    'Borrado!',
                    'El registro ha sido borrado.',
                    'success'
                    )
                    this.getArticulos()
                })
            }})
        },
        validarArticulo(){
            console.log(this.newArticulo.grupo)
            if(this.isValid(this.newArticulo)){
                this.guardarArticulo()
            }else{
                Swal.fire({
                        title: 'Error',
                        text: 'Complete los datos faltantes',
                        icon: 'error',
                        timer: 3000,
                        });
            }
        },
        guardarArticulo(){
            axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
            axios({
                method:'POST',
                url: '/stock/guardararticulo',
                data:this.newArticulo,
            })
            .then(res=>{
                console.log(res)
                this.getArticulos()
                this.newArticulo={art:'',cuota:'',costo:'',grupo:'',activo:'',codigo:''},
                Swal.fire({
                        title: 'Exito',
                        text: 'Articulo Agregado',
                        icon: 'success',
                        timer: 3000,
                        });
            })
            .catch(error=>{
              Swal.fire({
                        title: 'Error',
                        text: 'El registro no se proceso',
                        icon: 'error',
                        timer: 3000,
                        });
            })
        },
        toggleactivo(id){
          axios.get('/stock/articulotoggleactivo/'+id)
          .then(res=>{
            this.getArticulos()
          })
        },
        editarArticulo(id){
            this.verModalEdicion = true
            this.Articulo = this.articulos.filter(row=>row.id==id)[0]
        },
        validarEdicion(){
            if(this.isValid(this.Articulo)){
                this.guardarEdicion()
            }else{
                  Swal.fire({
                        title: 'Error',
                        text: 'Complete los datos faltantes',
                        icon: 'error',
                        timer: 3000,
                        });
            }
        },
        guardarEdicion(){
          axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
          axios({
              method:'POST',
              url: '/stock/guardaredicionarticulo',
              data: this.Articulo
          })
          .then(res=>{
            this.verModalEdicion = false
            this.getArticulos()
            Swal.fire({
                        title: 'Exito',
                        text: 'Edicion procesada',
                        icon: 'success',
                        timer: 3000,
                        });
          })
          .catch(error=>{
                         Swal.fire({
                                    title:'Error',
                                    text:'No se hizo la Edicion',
                                    icon: 'error',
                                    timer: 3000,
                                    });
          })
        },
        isValid(obj){
            for (const item in obj){
                if(!obj[item]) return false
            }
            return true
        },
        generarLista(){
            axios.get('/stock/generarlistaprecios')
                .then(res=>{
                    console.log(res.data.lista)
                    Swal.fire({
                        title:'Exito!',
                        text:'Se genero la lista',
                        icon: 'success',
                        timer: 3000,
                    })
                })
                .catch(error=>{
                    Swal.fire({
                        title:'Error!',
                        text: 'Posiblemente falta algun codigo',
                        icon: 'error',
                        timer: 3000,
                    })
                })
        },
    }}


</script>
{% endblock %}

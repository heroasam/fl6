{% extends "base.html" %}

{% block title %}Planillas de Rendicion{% endblock %}
{% block style %}
<style>
 .procesada{
    background-color: gainsboro;
    color: black;
}
.noprocesada{
    background-color: yellow;
    color: black;
}
thead th {
    position: sticky;
    position: -webkit-sticky;
    top: 0px;
    z-index: 10;
    background-color: #837e7e;
    color:white;
}
 table td:nth-child(n+3){
     text-align: right;
 }

</style>
{% endblock %}

{% block content %}

<div id="app" class="container">

    <p class="title is-1">Planillas de Cobranza</p>

    <div class="buttons">
        <a href="/pagos" class="button is-primary">Pagos</a>
        <a href="/loterbo" class="button is-primary">Registrar Lote Rbos</a>
        <a href="/loterbo/ver" class="button is-primary">Ver Lote Rbos</a>
        <a href="/pagos/editarrbo" class="button is-primary">Editar Rbo</a>
        <a href="/pagos/verzona" class="button is-primary">Ver Zona</a>
        <a href="/pagos/cobrostotales" class="button is-primary">Totales</a>
        <a href="/pagos/estimados" class="button is-primary">Estimados</a>
        <a href="/pagos/comisiones" class="button is-primary">Comisiones</a>
        <a href="/pagos/altas" class="button is-primary">Altas</a>
        <a href="/pagos/bajas" class="button is-primary">Bajas</a>
      </div>

    <table class="table table-sm" id="table">
        <thead>
            <tr>
                <th>Op</th>
                <th>fecha</th>
                <th class="sumar numeric">cobrado</th>
                <th class="sumar numeric">comision</th>
                <th class="sumar numeric">viatico</th>
                <th class="sumar numeric">neto</th>
                <th class="sumar numeric">cntrbos</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="planilla in planillas" :class="planilla['cobrado']!=planilla['cobradocaja']||planilla['viatico']!=planilla['viaticocaja']?'noprocesada':'procesada'">
                <td><button class="btn btn-outline-primary btn-sm" @click="procesarPlanilla(planilla['fecha'],planilla['cobrado'],planilla['comision'],planilla['viatico'])">Procesar</button></td>
                <td>|planilla['fecha']|</td>
                <td class="pesos">|planilla['cobrado']|</td>
                <td class="pesos">|planilla['comision']|</td>
                <td class="pesos">|planilla['viatico']|</td>
                <td class="pesos" style="font-weight:bold;">|planilla['cobrado']-planilla['comision']-planilla['viatico']|</td>
                <td>|planilla['cntrbos']|</td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm">
        <thead>
            <tr>
                <th>fecha</th>
                <th>cobr</th>
                <th class="sumar numeric">cobrado</th>
                <th class="sumar numeric">comision</th>
                <th class="sumar numeric">viatico</th>
                <th class="sumar numeric">neto</th>
                <th class="sumar numeric">cntrbos</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="plcobr in planillascobr">
                <td>|plcobr['fecha']|</td>
                <td>|plcobr['idcobr']|</td>
                <td class="pesos">|plcobr['cobrado']|</td>
                <td class="pesos">|plcobr['comision']|</td>
                <td class="pesos">|plcobr['viatico']|</td>
                <td class="pesos" style="font-weight:bold;">|plcobr['cobrado']-plcobr['comision']-plcobr['viatico']|</td>
                <td>|plcobr['cntrbos']|</td>
            </tr>
        </tbody>
    </table>
                <input type="hidden" name="csrf_token" ref="token" value="{{ csrf_token() }}"/>
</div>

{% endblock %}
{% block script %}
<script>
const app = new Vue({
    el:"#app",
    delimiters:['|','|'],
    data:{
        planillas:[],
        planillascobr:[],
    },
    methods: {
        getPlanillas(){
            axios.get('/pagos/getplanillas')
            .then(res=>{
                arrayPlanillas = Array.from(res.data.planillas)
                arrayPlanillas.forEach(row=>{
                    row['fecha']=dayjs.utc(row['fecha']).format('YYYY-MM-DD')
                })
                this.planillas = arrayPlanillas
                //console.log(this.planillas);
            })
        },
            getPlanillasCobr(){
                axios.get('/pagos/getplanillascobr')
                        .then(res=>{
                                this.planillascobr = res.data.planillascobr
                                this.planillascobr.map(row=>row['fecha']=dayjs.utc(row['fecha']).format('YYYY-MM-DD'))
                                //console.log(this.planillascobr)
                            })
                },
        procesarPlanilla(fecha,cobrado,comision,viatico){
            //console.log('procesado',procesado)
            //proceso unicamente cuando la columna procesada esta en null
            axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value;
            axios({
                method:'POST',
                url:'/pagos/procesarplanilla',
                data:{
                    fecha,
                    cobrado,
                    comision,
                    viatico,
                }
            })
            .then(res=>{
                console.log(res);
                this.getPlanillas();
            })
        },
    },
    created: function(){
        this.getPlanillas();
        this.getPlanillasCobr();
    },
})

</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Planillas de Cobranza{% endblock %}
{% block style %}
<style>
 table td:nth-child(n+3){
     text-align: right;
 }
</style>
{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="getPlanillas()">

  <!-- <div class="buttons">
       <a href="/pagos" class="button is-primary">Pagos</a>
       <a href="/loterbo" class="button is-primary">Registrar Lote Rbos</a>
       <a href="/loterbo/ver" class="button is-primary">Ver Lote Rbos</a>
       <a href="/pagos/editarrbo" class="button is-primary">Editar Rbo</a>
       <a href="/pagos/verzona" class="button is-primary">Ver Zona</a>
       <a href="/pagos/cobrostotales" class="button is-primary">Totales</a>
       <a href="/pagos/estimados" class="button is-primary">Estimados</a>
       <a href="/pagos/comisiones" class="button is-primary">Comisiones</a>
       <a href="/pagos/altas" class="button is-primary">Altas</a>
       <a href="/pagos/bajas" class="button is-primary">Bajas</a>
       </div> -->

  <p class="title is-1">Planillas de Cobranza</p>

  <table class="table" id="table">
    <thead>
      <tr>
        <th>+</th>
        <th>fecha</th>
        <th class="sumar numeric">cobrado</th>
        <th class="sumar numeric">comision</th>
        <th class="sumar numeric">viatico</th>
        <th class="sumar numeric">neto</th>
        <th class="sumar numeric">cntrbos</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <template x-for="planilla in listaPlanillas">
        <tr :class="planilla.cobrado!=planilla.cobradocaja||planilla.viatico!=planilla.viaticocaja?'noprocesada':'procesada'"
            :id="planilla.fecha">
          <td><span class="icon is-small"><i class="fa fa-plus-square-o" aria-hidden="true" @click="expandChildren(planilla.fecha)"></td>
            <td x-text="planilla.fecha"></td>
            <td x-text="planilla.cobrado" class="pesos"></td>
            <td x-text="planilla.comision" class="pesos"></td>
            <td x-text="planilla.viatico" class="pesos"></td>
            <td x-text="planilla.cobrado-planilla.comision-planilla.viatico"
                class="pesos" style="font-weight:bold;"></td>
            <td x-text="planilla.cntrbos"></td>
            <td><button class="button is-primary is-small" @click="procesarPlanilla(planilla.fecha)">Procesar</button></td>
        </tr>
      </template>

      <template x-for="item in planillaFecha">
        <tr class="children">
          <td x-text="item.idcobr" class="bold "></td>
          <td x-text="item.fecha"></td>
          <td x-text="item.cobrado" class="pesos"></td>
          <td x-text="item.comision" class="pesos"></td>
          <td x-text="item.viatico" class="pesos"></td>
          <td x-text="item.cobrado-item.comision-item.viatico"
              class="pesos" style="font-weight:bold;"></td>
          <td x-text="item.cntrbos"></td>
          <td></td>
        </tr>
      </template>
    </tbody>
  </table>
  <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
</div>

{% endblock %}
{% block script %}
<script>
 function main(){
     return{
         listaPlanillas:[],
         planillaFecha:[],
         Planilla:{},
         fecha:'',
         getPlanillas(){
             axios.get('/pagos/getplanillas')
                  .then(res=>{
                      this.listaPlanillas = res.data.planillas
                      this.listaPlanillas.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                  })
         },
         procesarPlanilla(fecha){
             this.Planilla = this.listaPlanillas.filter(row=>row.fecha==fecha)[0]
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value;
             axios.post('/pagos/procesarplanilla',this.Planilla)
                  .then(res=>{
                      this.getPlanillas();
                      msgSuccess('Planilla procesada')
                  })
                  .catch(error=>msgError('Error.No se proceso nada.'))
         },
         expandChildren(fecha){
             if(this.fecha==fecha && this.planillaFecha.length>0){
                 this.planillaFecha = []
                 return
             }
             axios.get('/pagos/getplanillas/'+fecha)
                  .then(res=>{
                      this.planillaFecha = res.data.planillas
                      this.planillaFecha.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                      this.fecha = fecha
                      setTimeout(()=>{
                          $tbody = document.querySelector('tbody')
                          $trfecha = document.getElementById(fecha)
                          let arrayrows = Array.from($tbody.children)
                          let children = arrayrows.filter(row=>row.classList.contains('children'))
                          children = children.reverse()
                          for(el of children){
                              $tbody.insertBefore(el,$trfecha.nextSibling)
                      }},10)
                  })
         },
 }}

</script>
{% endblock %}

{% extends "base_template.html" %} {% block title %}Bajas{% endblock %} {%
    block style %}
    <style></style>
    {% endblock %} 
    
    {% block content %}
    
    <div class="container">
        <p class="title is-1">Bajas Seven</p>
        <div class="buttons">
            <a href="/pagos" class="button is-primary">Pagos</a>
            <a href="/pagos/verplanillas" class="button is-primary">Planillas</a>
            <a href="/loterbo" class="button is-primary">Registrar Lote Rbos</a>
            <a href="/loterbo/ver" class="button is-primary">Ver Lote Rbos</a>
            <a href="/pagos/editarrbo" class="button is-primary">Editar Rbo</a>
            <a href="/pagos/verzona" class="button is-primary">Ver Zona</a>
            <a href="/pagos/cobrostotales" class="button is-primary">Totales</a>
            <a href="/pagos/estimados" class="button is-primary">Estimados</a>
            <a href="/pagos/comisiones" class="button is-primary">Comisiones</a>
            <a href="/pagos/altas" class="button is-primary">Altas</a>
          </div>
    
        <div x-data="main()" x-init="loadBajas()">
            <div>
                <button class="button is-black" @click="generarCSV()">Generar CSV</button>
                <button class="button is-black" @click="marcarBajados()">Marcar Bajados</button>
            </div>
            <table class="table" id="table">
                <thead>
                    <tr>
                        <th>credito</th>
                        <th>nombre</th>
                        <th>dni</th>
                        <th>canc/reg</th>
                        <th>fecha</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="item in listBajas">
                    <tr>
                        <td x-text="item['dni']"></td>
                        <td x-text="item['nombre']"></td>
                        <td x-text="item['dni']"></td>
                        <td x-text="item['canc']"></td>
                        <td x-text="item['ultpago']"></td>
                    </tr>
                    </template>
                </tbody>
            </table>
            <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>

         </div>
    {% endblock %} {% block script %}
    <script>
        function main(){
            return {
                listBajas:[],
                sevenBajas:[],
                loadBajas(){
                    axios.get('/pagos/loadbajas')
                    .then(res=>{
                        this.listBajas=res.data.listbajas
                        this.listBajas.map(row=>row['ultpago']=dayjs.utc(row['ultpago']).format('YYYY-MM-DD'))
                    })
                },
                generarCSV(){
                    axios.get('/pagos/sevenaltas')
                    .then(res=>{
                        let listaBajas = [...this.listBajas]
                        let enc = []
                        enc.push(['Cordoba',dayjs.utc().format('YYYY-MM-DD'),'','',''])
                        enc.push(['','','','',''])
                        enc.push(['ADHERENTE 2210 - ROMITEX', '','','',''])
                        enc.push(['','','','',''])
                        enc.push(['SeÃ±ores de','','','',''])
                        enc.push(['SEVEN S.R.L.','','','',''])
                        enc.push(['Presente','','','',''])
                        enc.push(['Por medio de la presente solicitamos desafectar a las siguientes personas:','','','',''])
                        enc.push(['Numero de credito','Apellido y Nombre','Documento','Canc/Reg','Fecha Desafectacion'])
                        enc.reverse().forEach(row=>listaBajas.unshift(row))
                        let csvContent = "data:text/csv;charset=utf-8," 
                        + listaBajas.map(e => e.join(",")).join("\n");
                        console.log(csvContent)
                        var encodedUri = encodeURI(csvContent);
                        var link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        link.setAttribute("download", "bajas.csv");
                        document.body.appendChild(link); // Required for FF

                        link.click(); //
                    })
                    
                },
                marcarBajados(){
                    this.loadBajas()
                    let listdni=[]
                    this.listBajas.forEach(row=>{
                        listdni.push(row['dni'])
                    })
                    
                    axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
                    axios({
                        method:'POST',
                        url: '/pagos/marcarbajados',
                        data: listdni
                    })
                    .then(res=>{
                        bulmaToast.toast({
                            message: "Registros marcados correctamente",
                            type: "is-success"
                        })
                        this.loadBajas()
                    })
                    .catch(error=>{
                        bulmaToast.toast({
                            message:error.request.response,
                            type: "is-danger"
                        })
                    })
                },
               
           
                
            }
        }
        
    </script>
    {% endblock %}
    

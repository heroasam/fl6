{% extends "base.html" %} {% block title %}Bajas{% endblock %} {%
block style %}
<style></style>
{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="loadBajas()">
  <div class="buttons">
    <a href="/pagos" class="button is-primary">Pagos</a>
    <a href="/pagos/verplanillas" class="button is-primary">Planillas</a>
    <a href="/loterbo" class="button is-primary">Registrar Lote Rbos</a>
    <a href="/loterbo/ver" class="button is-primary">Ver Lote Rbos</a>
    <a href="/pagos/editarrbo" class="button is-primary">Editar Rbo</a>
    <a href="/pagos/verzona" class="button is-primary">Ver Zona</a>
    <a href="/pagos/cobrostotales" class="button is-primary">Totales</a>
    <a href="/pagos/estimados" class="button is-primary">Estimados</a>
    <a href="/pagos/comisiones" class="button is-primary">Comisiones</a>
    <a href="/pagos/altas" class="button is-primary">Altas</a>
  </div>
  <p class="title is-1">Bajas Seven</p>

  <div class="block">
    <button class="button is-primary" @click="generarCSV()">Generar CSV</button>
    <button class="button is-primary" @click="marcarBajados()">Marcar Bajados</button>
    <button class="button is-primary" @click="verAyuda=!verAyuda">Ayuda</button>
  </div>
  <div class="columns">
    <div class="column is-8">
      <div class="notification is-warning block" x-show="verAyuda">
        <p class="title is-3">Procedimiento para enviar datos al Seven</p>
        <ul>
          <li><p class="subtitle is-5">Generar el archivo CSV y abrirlo con LibreOffice, revisarlo.</p></li>
          <li><p class="subtitle is-5">Dar un nombre apropiado "BajasRomitex-MesAño"</p></li>
          <li><p class="subtitle is-5">"Guardar como..." dentro de LibreOffice como Excel 97-2003 formato .xls</p></li>
          <li><p class="subtitle is-5">Enviar ese archivo con el de Altas a datos@seven.com.ar</p></li>
          <li><p class="subtitle is-5">Por ultimo marcar los registros bajados con el boton MARCAR BAJADOS</p></li>
          <li><p class="subtitle is-5">El listado debe quedar vacio</p></li>
        </ul>
      </div>
      <table class="table nototal" id="table">
        <thead>
          <tr>
            <th>credito</th>
            <th>nombre</th>
            <th>dni</th>
            <th>canc/reg</th>
            <th>fecha</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="item in listBajas">
            <tr>
              <!-- <td><button class="button is-small is-danger" @click="marcarBaja(item.dni)">Marcar</button></td> -->
              //Deshabilito el boton marcarBaja por cuanto las bajas individuales se estan cursando ahora por whatsapp.
              <td x-text="item.dni"></td>
              <td x-text="item.nombre"></td>
              <td x-text="item.dni"></td>
              <td x-text="item.canc"></td>
              <td x-text="item.ultpago"></td>
            </tr>
          </template>
        </tbody>
      </table>
      <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
    </div>
  </div>


</div>
{% endblock %} {% block script %}
<script>
 function main(){
     return {
         listBajas:[],
         sevenBajas:[],
         verAyuda:false,
         loadBajas(){
             axios.get('/pagos/loadbajas')
                  .then(res=>{
                      this.listBajas=res.data.listbajas
                      this.listBajas.map(row=>row.ultpago=dayjs.utc(row.ultpago).format('YYYY-MM-DD'))
                  })
         },
         generarCSV(){
             axios.get('/pagos/sevenbajas')
                  .then(res=>{
                      /* let listaBajas = [...this.listBajas] */
			          let listaBajas = res.data.sevenbajas
			          listaBajas.map(row=>row[4]=dayjs.utc(row[4]).format('YYYY-MM-DD'))
                      let enc = []
                      enc.push(['Cordoba',dayjs.utc().format('YYYY-MM-DD'),'','',''])
                      enc.push(['','','','',''])
                      enc.push(['ADHERENTE 2210 - ROMITEX', '','','',''])
                      enc.push(['','','','',''])
                      enc.push(['Señores de','','','',''])
                      enc.push(['SEVEN S.R.L.','','','',''])
                      enc.push(['Presente','','','',''])
                      enc.push(['Por medio de la presente solicitamos desafectar a las siguientes personas:','','','',''])
                      enc.push(['Numero de credito','Apellido y Nombre','Documento','Canc/Reg','Fecha Desafectacion'])
                      enc.reverse().forEach(row=>listaBajas.unshift(row))
                      let csvContent = "data:text/csv;charset=utf-8,"
                                     + listaBajas.map(e => e.join(",")).join("\n");
                      var encodedUri = encodeURI(csvContent);
                      var link = document.createElement("a");
                      link.setAttribute("href", encodedUri);
                      link.setAttribute("download", "bajas.csv");
                      document.body.appendChild(link); // Required for FF

                      link.click(); //
                  })

         },
         marcarBajados(){
             this.loadBajas()
             let listdni=[]
             this.listBajas.forEach(row=>{
                 listdni.push(row['dni'])
             })
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/pagos/marcarbajados',listdni)
                                                                 .then(res=>{
                                                                     msgSuccess('Registros marcados correctamente')
                                                                     this.loadBajas()
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError(error.request.response)
                                                                 })
         },
         marcarBaja(dni){
             let listdni = [dni]
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/pagos/marcarbajados',listdni)
                                                                 .then(res=>{
                                                                     msgSuccess('Registro marcado correctamente')
                                                                     this.loadBajas()
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError(error.request.response)
                                                                 })
         },
     }
 }
</script>
{% endblock %}

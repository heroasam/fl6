{% extends "base.html" %}

{% block title %}PasarPagos{% endblock %}

{% block style %}
<style>
</style>
{% endblock %}

{% block content %}
<div x-data="main()" class="container">
  <div class="buttons">
    <a href="/pagos/verplanillas" class="button is-primary">Planillas</a>
    <a href="/loterbo" class="button is-primary">Registrar Lote Rbos</a>
    <a href="/loterbo/ver" class="button is-primary">Ver Lote Rbos</a>
    <a href="/pagos/editarrbo" class="button is-primary">Editar Rbo</a>
    <a href="/pagos/verzona" class="button is-primary">Ver Zona</a>
    <a href="/pagos/cobrostotales" class="button is-primary">Totales</a>
    <a href="/pagos/estimados" class="button is-primary">Estimados</a>
    <a href="/pagos/comisiones" class="button is-primary">Comisiones</a>
    <a href="/pagos/altas" class="button is-primary">Altas</a>
    <a href="/pagos/bajas" class="button is-primary">Bajas</a>
  </div>
  <p class="title is-1">Pasar Pagos</p>

  <div class="grid block">
    <div class="flex">
      <input type="date" x-model="Pagos.fecha" class="input" style="width:200px;"
             :class="darkTheme?'input-dark':''">
      <input type="text" x-model="Pagos.cobr" class="input" style="width:100px;"
             @keyup.enter="cargarListado();$refs.buscar.focus()"
             :class="darkTheme?'input-dark':''" placeholder="Cobr">
      <button class="button is-primary" @click="cargarListado()">Cargar Planilla</button>
      <span x-text="nombrecobrador" x-show="nombrecobrador && !isMobileDevice" class="title is-5 ml-5 tag"></span>
    </div>

	<div class="flex">
      <input type="text" x-model="buscar" class="input" style="width:300px;" @keyup.enter="buscarCliente();$refs.imp.focus();
                   setTimeout(()=>{$refs.imp.select()},600)" @focus="Clientes=[];Ventas=[];Venta={};Pagos.rec='';Pagos.imp='';buscar=''"
             x-ref="buscar" :class="darkTheme?'input-dark':''" placeholder="Buscar Cuenta o Nombre">
	  <button class="button is-primary" @click="buscarCliente()">Buscar</button>
	</div>

    <div class="buttons">
      <template x-for="cliente in Clientes">
        <button class="button is-primary" x-text="cliente.nombre" @click="Clientes=[];Clientes[0]=cliente;pedirVentas(cliente.dni)"></button>
      </template>
      <div id="btnVentas">
        <template x-for="venta in Ventas">
          <button class="button is-danger" x-text="venta.id" @click="toggleMarcado;obtenerVenta(venta.id)"></button>
        </template>
      </div>
    </div>

    <div>
      <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
	  <span class="tag is-danger is-large" x-text="`Saldo ${Venta.saldo?Venta.saldo:''}`"></span>
	  <span class="tag is-secondary is-large" x-text="`Cuota ${Venta.ic?Venta.ic:''}`"></span>
	  <input id="importe" type="text" placeholder="Importe" class="input center" x-model="Pagos.imp" style="width: 100px;"
             @keyup.enter="$refs.recibo.focus()" x-ref="imp"
             :class="darkTheme?'input-dark':''"/>
	  <input type="text" placeholder="Recargo" class="input center" x-model="Pagos.rec" style="width: 100px;"
             :class="darkTheme?'input-dark':''"/>
	  <input type="text" placeholder="Total" class="input center" :value="+(Pagos.imp?Pagos.imp:0)+(+(Pagos.rec?Pagos.rec:0))"
             style="width: 100px;" :class="darkTheme?'input-dark':''"/>
	  <input id="recibo" type="text" placeholder="Rbo N°" class="input center" style="width: 100px;" x-model="Pagos.rbo"
             @keyup.page-up="+Pagos.rbo++" @keyup.page-down="+Pagos.rbo--" @keyup.enter="validatePasarPagos" x-ref="recibo"
             :class="darkTheme?'input-dark':''"/>
	  <button class="button is-danger" type="button" @click="validatePasarPagos">Pasar</button>
	</div>
  </div>


  <div class="flex" x-show="Planilla.cntrbos">
    <span class="tag is-large" :class="darkTheme?'is-dark':'is-light'" x-text="'Cnt Rbos  '+Planilla.cntrbos"></span>
    <span class="tag is-large" :class="darkTheme?'is-dark':'is-light'" x-text="'Cobrado $'+Planilla.cobrado"></span>
    <span class="tag is-large" :class="darkTheme?'is-dark':'is-light'" x-text="'Comision $'+Planilla.comision"></span>
    <span class="tag is-large" :class="darkTheme?'is-dark':'is-light'">Viatico $</span>
	<input type="text" placeholder="Viaticos" class="input" :class="darkTheme?'input-dark':''" size="6" x-model="Planilla.viatico"
           style="width: 100px;"  id="viatico" />
	<button class="button is-dark" @click="pasarPlanilla">Guardar Planilla</button>
  </div>



  <table id="table" class="table is-narrow" x-show="listado.length">
	<thead>
	  <tr>
        <th></th>
		<th>id</th>
		<th>rbo</th>
		<th>fecha</th>
		<th>idvta</th>
		<th class="numeric sumar">imp</th>
		<th class="numeric sumar">rec</th>
		<th class="numeric sumar">total</th>
		<th>nombre</th>
		<th>direccion</th>
		<th>zona</th>
		<th class="numeric">deuda</th>
	  </tr>
	</thead>
	<tbody>
	  <template x-for="lista in listado">
		<tr :class="lista.deuda==0?'cancelada':'normal'">
          <td><i class="fa fa-times" aria-hidden="true" @click="borrarPago(lista.id)"></td>
		    <td x-text="lista.id"></td>
		    <td x-text="lista.rbo"></td>
		    <td x-text="lista.fecha"></td>
		    <td x-text="lista.idvta"></td>
		    <td class="pesos" x-text="lista.imp"></td>
		    <td class="pesos" x-text="lista.rec"></td>
		    <td class="pesos" x-text="lista.total"></td>
		    <td x-text="lista.nombre"></td>
		    <td x-text="lista.direccion"></td>
		    <td x-text="lista.zona"></td>
		    <td class="pesos" x-text="lista.deuda"></td>
		</tr>
	  </template>
	</tbody>
  </table>

</div>
{% endblock %}

{% block script %}
<script>
 function main(){
     return{
         nombrecobrador:'',
         buscar:'',
         listado:[],
         planilla:[],
         Clientes:[],
         Ventas:[],
         Venta:{},
         Planilla:{},
         Pagos:{fecha:dayjs.utc().format('YYYY-MM-DD'),cobr:'',rec:''},
         buscaCobrador(cobr){
             axios.get('/loterbo/buscanombrecobr/'+cobr)
                  .then(res=>{
                      this.nombrecobrador=res.data.nombrecobr
                  })
         },
         cargarListado(){
             axios.get('/pagos/listado/'+this.Pagos.fecha+'/'+this.Pagos.cobr)
                  .then(res=>{
                      this.listado = res.data.listado
                      this.listado.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                      this.planilla = res.data.planilla
                      this.buscaCobrador(this.Pagos.cobr)
                      let rbos = []
                      let imppagos = []
					  this.listado.forEach(row=>{
						  rbos.push(row.rbo)
                          imppagos.push(row.total)
					  })
					  let setrbos = new Set(rbos)
					  this.Planilla.cntrbos = setrbos.size

					  this.Planilla.cobrado = imppagos.reduce((a, b) => Number(a) + Number(b), 0);
					  this.Planilla.comision = Math.round(this.Planilla.cobrado * 0.15);
                      if(this.planilla.length) this.Planilla.viatico = this.planilla[0].viatico
                  })
         },
         buscarCliente(){
             axios.get('/pagos/buscar/'+this.buscar)
                  .then(res=>{
                      this.Clientes=res.data.clientes
                      if(this.Clientes.length==1) this.pedirVentas(this.Clientes[0].dni)
                      if(this.Clientes.length==0) {
                          let pattern = /\d{5,6}/g
                          if(pattern.test(this.buscar)){
                              msgError('No existe esa cuenta')
                          }else{
                              msgError('No existe ningun cliente con esa busqueda')
                          }
                      }
                  })
         },
         pedirVentas(dni){
             axios.get('/pagos/idvtas/'+dni)
                  .then(res=>{
                      this.Ventas=res.data.idvtas
                      if(this.Ventas.length==1){
                          this.obtenerVenta(this.Ventas[0].id)
                      }
                      if(this.Ventas.length==0){
                          msgError('Ese cliente no tiene ninguna cuenta deudora')
                      }
                  })
         },
         obtenerVenta(idvta){
             axios.get('/pagos/traerficha/'+idvta)
                  .then(res=>{
                      this.Venta=res.data.ficha
                      this.Pagos.imp = this.Venta.imp
                  })

         },
         validatePasarPagos(){
             if(this.Pagos.imp&&this.Pagos.rbo&&this.Pagos.cobr&&this.Pagos.fecha){
                 this.procesarPagos()
             }else{
                 msgError('Complete los datos faltantes')
             }
         },
         procesarPagos(){
             this.Pagos.idvta = this.Venta.id
             this.Pagos.idcliente = this.Venta.idcliente
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value;
             axios.post('/pagos/pasarpagos', this.Pagos)
                  .then(res=>{
                      this.cargarListado()
                      this.Venta={}
                                +this.Pagos['rbo']++
                                 this.Pagos['imp']=''
                      this.Pagos['rec']=''
                      this.buscar=''
                      this.$refs.buscar.focus()
                  })
         },
         borrarPago(id){
             Pago = this.listado.filter(row=>row.id==id)[0]
             Swal.fire({
                 title: '¿Esta seguro?',
                 text: `Se borrara el recibo Nº${Pago.rbo} perteneciente a ${Pago.nombre}`,
                 icon: 'warning',
                 showCancelButton: true,
                 confirmButtonColor: '#3085d6',
                 cancelButtonColor: '#d33',
                 confirmButtonText: 'Si, borrarlo!'
             }).then((result) => {
                 if (result.isConfirmed) {
                     axios.get('/pagos/borrarpago/'+id)
                          .then(res=>{
                              msgSuccess('Borrado!','El pago ha sido borrado')
                              this.cargarListado()})
                          .catch(error=>msgError('Error','No se pudo borrar el pago.'))
             }})
         },
         pasarPlanilla(){
             this.Planilla.fecha = this.Pagos.fecha
             this.Planilla.idcobr = this.Pagos.cobr
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value;
			 axios.post('/pagos/pasarplanilla', this.Planilla)
			      .then(res => {
                      msgSuccess('Planilla agregada/corregida con exito')
			      })
         },
         limpiarToggle(){
             btnVentas = document.getElementById('btnVentas')
             for(let button of btnVentas.children){
                 button.classList.remove('is-warning')
                 button.classList.add('is-danger')
             }
         },
         toggleMarcado(e){
             this.limpiarToggle()
             if(this.Ventas.length>1){
                 console.log( 'hay dos ventas')
                 e.target.classList.add('is-warning')
                 e.target.classList.remove('is-danger')
             }
         },
 }}
 //el event up/down no funciona para cambio de numero de recibo
</script>

{% endblock %}

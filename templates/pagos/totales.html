{% extends "base.html" %}

{% block title %}Totales{% endblock %}
{% block style %}
<style>
 td:before {
     content:'$';
 }
</style>
{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="getInflacion()">


  <div class="buttons">
    <a href="/pagos" class="button is-primary">Pagos</a>
    <a href="/pagos/verplanillas" class="button is-primary">Planillas</a>
    <a href="/loterbo" class="button is-primary">Registrar Lote Rbos</a>
    <a href="/loterbo/ver" class="button is-primary">Ver Lote Rbos</a>
    <a href="/pagos/editarrbo" class="button is-primary">Editar Rbo</a>
    <a href="/pagos/verzona" class="button is-primary">Ver Zona</a>
    <a href="/pagos/estimados" class="button is-primary">Estimados</a>
    <a href="/pagos/comisiones" class="button is-primary">Comisiones</a>
    <a href="/pagos/altas" class="button is-primary">Altas</a>
    <a href="/pagos/bajas" class="button is-primary">Bajas</a>
  </div>
  <p class="title is-1">Totales Cobrados</p>

  {{tbl|safe}}
  <div class="is-6">
    <canvas id="grafico-estadistica" width="600" height="400"></canvas>
  </div>
  <p class="subtitle is-3">Totales por Zona</p>
  {{tbl1|safe}}

</div>
{% endblock %}

{% block script %}
<script>
 function main(){
     return{
	 mescobranza:[],
	 cobranzatotal:[],
	 cobranzacorregida:[],
	 listaInflacion:[],
	 obtenerTotales(){
	     let tableId = document.getElementById('totales')
	     let thead = tableId.querySelector('thead');
	     this.mescobranza = Array.from(Array.from(thead.rows)[0].children).map(row=>row.innerText).slice(1)
	     let tbody = tableId.querySelector('tbody');
	     let rowsArray = Array.from(tbody.rows);
	     let rowIndex=[];
	     rowsArray.forEach((row)=>{
		 rowIndex.push(row.rowIndex-1)
	     });
	     let maxRow = Math.max(...rowIndex)+1;
	     let $rowTotal = tbody.insertRow(maxRow);
	     let $cell0 = $rowTotal.insertCell(0);
	     $cell0.innerHTML = "Total";
	     $rowTotal.classList.add('total');

	     const cols = rowsArray[0].children.length // determino la cant columnas
	     for(let i=1;i<cols;i++){
		 let col = [];
		 rowIndex.forEach((ix)=>{
		     col.push(nop(tbody.rows[ix].cells[i].innerText))
		 });
		 let total = col.reduce((a,b)=>Number(a)+Number(b));
		 let $cell = $rowTotal.insertCell(i);
		 if (!(Number.isNaN(total))) $cell.innerHTML = total
		 this.cobranzatotal.push(total)
	     }
             this.cobranzacorregida = this.cobranzatotal
	 },
	 getGrafico(){
             const canvas = document.getElementById('grafico-estadistica').getContext('2d');
             const chart = new Chart(canvas, {
		 type: 'bar',
		 data: {
                     labels: this.mescobranza,
                     datasets: [{
			 label: 'Cobranza Mensual',
			 data: this.cobranzatotal,
			 order: 1,
			 backgroundColor: [
                             'rgba(255, 99, 132, 0.2)',
                             'rgba(54, 162, 235, 0.2)',
                             'rgba(255, 206, 86, 0.2)',
                             'rgba(75, 192, 192, 0.2)',
                             'rgba(153, 102, 255, 0.2)',
                             'rgba(255, 159, 64, 0.2)'
			 ],
			 borderColor: [
                             'rgba(255, 99, 132, 1)',
                             'rgba(54, 162, 235, 1)',
                             'rgba(255, 206, 86, 1)',
                             'rgba(75, 192, 192, 1)',
                             'rgba(153, 102, 255, 1)',
                             'rgba(255, 159, 64, 1)'
			 ],
			 borderWidth: 1
                     },
				{
				    label: 'Actualizacion por Inflacion',
				    data: this.cobranzacorregida,
				    borderColor:                             'rgb(22, 183, 237)',
				    type:'line',
				    order:0,
				}
		     ]
		 },
		 options: {
                     scales: {
			 y: {
                             beginAtZero: true
			 }
                     }
		 }
             });
	 },
	 getInflacion(){
             axios.get('/buscador/tablainflacion')
                  .then(res=>{
                      this.listaInflacion = res.data.inflacion
		      this.obtenerTotales()
		      //hacemos un array de cobranza corregida por inflacion
		      this.cobranzacorregida=this.cobranzacorregida.map((row,index)=>row=row*this.listaInflacion[dayjs(this.mescobranza[index]).format('YYYYM')])
		      this.getGrafico()
         })},

 }}
</script>
{% endblock %}

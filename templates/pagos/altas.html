{% extends "base.html" %} {% block title %}Altas{% endblock %} {%
    block style %}
    <style></style>
    {% endblock %} 
    
    {% block content %}
    
    <div class="container">
        <p class="title is-1">Altas Seven</p>
        <div class="buttons">
            <a href="/pagos" class="button is-primary">Pagos</a>
            <a href="/pagos/verplanillas" class="button is-primary">Planillas</a>
            <a href="/loterbo" class="button is-primary">Registrar Lote Rbos</a>
            <a href="/loterbo/ver" class="button is-primary">Ver Lote Rbos</a>
            <a href="/pagos/editarrbo" class="button is-primary">Editar Rbo</a>
            <a href="/pagos/verzona" class="button is-primary">Ver Zona</a>
            <a href="/pagos/cobrostotales" class="button is-primary">Totales</a>
            <a href="/pagos/estimados" class="button is-primary">Estimados</a>
            <a href="/pagos/comisiones" class="button is-primary">Comisiones</a>
            <a href="/pagos/bajas" class="button is-primary">Bajas</a>
          </div>
    
        <div x-data="main()" x-init="loadAltas()">
            <div>
                <button class="button is-black" @click="generarCSV()">Generar CSV</button>
                <button class="button is-black" @click="marcarSubidos()">Marcar Subidos</button>
            </div>
            <table class="table nototal" id="table">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>nombre</th>
                        <th>dni</th>
                        <th>sex</th>
                        <th>calle</th>
                        <th>num</th>
                        <th>deuda</th>
                        <th>ultpago</th>
                        <th>SUBE</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="item in listAltas">
                    <tr>
                        <td x-text="item['id']"></td>
                        <td x-text="item['nombre']"></td>
                        <td x-text="item['dni']"></td>
                        <td x-text="item['sex']"></td>
                        <td x-text="item['calle']"></td>
                        <td x-text="item['num']"></td>
                        <td x-text="item['deuda']"></td>
                        <td x-text="item['ultpago']"></td>
                        <td><button class="button is-small is-info" x-text="item['subirseven']?'SUBE':'noSUBE'" @click="toggleSube(item['id'])"></button></td>
                    </tr>
                    </template>
                </tbody>
            </table>
            <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>

         </div>
    {% endblock %} {% block script %}
    <script>
        function main(){
            return {
                listAltas:[],
                sevenAltas:[],
                loadAltas(){
                    axios.get('/pagos/loadaltas')
                    .then(res=>{
                        this.listAltas=res.data.listaltas
                        this.listAltas.map(row=>row['ultpago']=dayjs.utc(row['ultpago']).format('YYYY-MM-DD'))
                    })
                },
                toggleSube(id){
                    if(event.target.innerText==='SUBE'){
                        event.target.innerText='noSUBE'
                    }else{
                        event.target.innerText='SUBE'
                    }
                    axios.get('/pagos/togglesube/'+id)
                    .then(res=>{
                    })
                },
                generarCSV(){
                    axios.get('/pagos/sevenaltas')
                    .then(res=>{
                        console.log(res.data.sevenaltas)
                        this.sevenAltas=res.data.sevenaltas
                        let enc = ['adherente','nro_credit','nro_docume','tipo','sexo','clase','cant','ayn','domicilio','cpostal', 'barrio','localidad','provincia','codigo_cob','fecha_ingr','codigo_act','aval','mail','telefono']
                        this.sevenAltas.unshift(enc)
                        let csvContent = "data:text/csv;charset=utf-8," 
                        + this.sevenAltas.map(e => e.join(",")).join("\n");
                        console.log(csvContent)
                        var encodedUri = encodeURI(csvContent);
                        var link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        link.setAttribute("download", "altas.csv");
                        document.body.appendChild(link); // Required for FF

                        link.click(); //
                    })
                    
                },
                marcarSubidos(){
                    this.loadAltas()
                    let listdni=[]
                    this.listAltas.forEach(row=>{
                        listdni.push(row['dni'])
                    })
                    
                    axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
                    axios({
                        method:'POST',
                        url: '/pagos/marcarsubidos',
                        data: listdni
                    })
                    .then(res=>{
                        bulmaToast.toast({
                            message: "Registros marcados correctamente",
                            type: "is-success"
                        })
                        this.loadAltas()
                    })
                    .catch(error=>{
                        bulmaToast.toast({
                            message:error.request.response,
                            type: "is-danger"
                        })
                    })
                },
               
           
                
            }
        }
        
    </script>
    {% endblock %}
    

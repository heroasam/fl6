{% extends "base.html" %}

{% block title %}Editar Recibos{% endblock %}
{% block style %}
<style>
</style>
{% endblock %}

{% block content %}
<div  class="container" x-data="main()">

  <div class="buttons">
    <a href="/pagos" class="button is-primary">Pagos</a>
    <a href="/pagos/verplanillas" class="button is-primary">Planillas</a>
    <a href="/loterbo" class="button is-primary">Registrar Lote Rbos</a>
    <a href="/loterbo/ver" class="button is-primary">Ver Lote Rbos</a>
    <a href="/pagos/verzona" class="button is-primary">Ver Zona</a>
    <a href="/pagos/cobrostotales" class="button is-primary">Totales</a>
    <a href="/pagos/estimados" class="button is-primary">Estimados</a>
    <a href="/pagos/comisiones" class="button is-primary">Comisiones</a>
    <a href="/pagos/altas" class="button is-primary">Altas</a>
    <a href="/pagos/bajas" class="button is-primary">Bajas</a>
  </div>
  <p class="title is-1">Editar Recibos</p>

  <input type="text" x-model="buscar" class="block inputrbo input" placeholder="Recibo a editar" @keyup.enter="obtenerRegRbo(buscar)">

  <div class="box block">
    <table class="table">
      <thead>
        <tr>
          <th>op</th>
          <th>op</th>
          <th>Id</th>
          <th>Fecha</th>
          <th>idvta</th>
          <th>imp</th>
          <th>rec</th>
          <th>rbo</th>
          <th>cobr</th>
          <th>idcliente</th>
          <th>nombre</th>
        </tr>
      </thead>
      <tbody>
        <template  x-for="rbo in rbos">
          <tr>
            <td><i class="fa fa-times" aria-hidden="true" @click="borrarRbo(rbo.id)"></td>
              <td><i class="fa fa-pencil" aria-hidden="true" @click="obtenerRbo(rbo.id)"></td>
                <td x-text="rbo.id"></td>
                <td x-text="rbo.fecha"></td>
                <td x-text="rbo.idvta"></td>
                <td x-text="rbo.imp"></td>
                <td x-text="rbo.rec"></td>
                <td x-text="rbo.rbo"></td>
                <td x-text="rbo.cobr"></td>
                <td x-text="rbo.idcliente"></td>
                <td x-text="rbo.nombre"></td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>








  <form @submit.prevent class="box field is-horizontal">
    <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
    <div class="field">
      <label class="label">Fecha</label>
      <input type="date" x-model="Rbo.fecha" style="width: 150px;" class="input is-narrow"
             @blur="nuevaFecha=true">
    </div>
    <div class="field">
      <label class="label">IdVta</label>
      <input type="text" x-model="Rbo.idvta" style="width: 100px" class="input is-narrow"
             @blur="obtenerNuevoNombre(Rbo.idvta)">
    </div>
    <div class="field">
      <label class="label">Imp</label>
      <input type="text" x-model="Rbo.imp" style="width: 70px;" class="input is-narrow"
             @blur="nuevoImp=true">
    </div>
    <div class="field">
      <label class="label">Rec</label>
      <input type="text" x-model="Rbo.rec" style="width: 70px;" class="input is-narrow"
      @blur="nuevoRec=true">

    </div>
    <div class="field">
      <label class="label">Rbo</label>
      <input type="text" x-model="Rbo.rbo" style="width: 100px;" class="input is-narrow" disabled>
    </div>
    <div class="field">
      <label class="label">Cobr</label>
      <input type="text" x-model="Rbo.cobr" style="width: 70px;" class="input is-narrow"
             @blur="nuevoCobr=true">
    </div>
  </form>

  <div class="notification is-warning m-4" x-show="nuevaFecha&&Rbo.fecha!=RboEditar.fecha">
    <p class="title is-4" x-text="'Se cambia la fecha del recibo de: '+RboEditar.fecha+' a '+Rbo.fecha"></p>
  </div>
  <div class="notification is-warning m-4" x-show="nuevoImp&&Rbo.imp!=RboEditar.imp">
    <p class="title is-4" x-text="'Se cambia el importe del recibo de: '+RboEditar.imp+' a '+Rbo.imp"></p>
  </div>
  <div class="notification is-warning m-4" x-show="nuevoRec&&Rbo.rec!=RboEditar.rec">
    <p class="title is-4" x-text="'Se cambia el recargo del recibo de: '+RboEditar.rec+' a '+Rbo.rec"></p>
  </div>
  <div class="notification is-warning m-4" x-show="nuevoNombre">
    <p class="title is-4" x-text="'Se cambia el titular del recibo de: '+RboEditar.nombre+' a '+nuevoNombre"></p>
  </div>
  <div class="notification is-warning m-4" x-show="nuevoCobr&&Rbo.cobr!=RboEditar.cobr">
    <p class="title is-4" x-text="'Se cambia el cobrador del recibo de: '+RboEditar.cobr+' a '+Rbo.cobr"></p>
  </div>
  <div class="notification is-danger m-4" x-show="nuevoCobr&&Rbo.cobr!=RboEditar.cobr||nuevaFecha&&Rbo.fecha!=RboEditar.fecha
              ||nuevoImp&&Rbo.imp!=RboEditar.imp||nuevoRec&&Rbo.rec!=RboEditar.rec||nuevoNombre">
    <p class="title is-4 center" >Al terminar de editar presione Guardar</p>
  </div>


  <button type="button" class="button ml-5" @click="validarEdicionRbo">Guardar</button>



</div>



{% endblock %}
{% block script %}
<script>
 function main(){
     return {
         buscar:'',
         Rbo:{},
         rbos:[],
         nuevoNombre:'',
         RboEditar:{},
         nuevaFecha:false,
         nuevoImp:false,
         nuevoRec:false,
         nuevoCobr:false,
         obtenerRegRbo(buscar){
             axios.get('/pagos/obtenerregrbo/'+buscar)
                  .then(res=>{
                      this.rbos = res.data.reg
                      this.rbos.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                  })
                  .catch(error=>msgError('No hay registros para ese recibo'))

         },
         obtenerRbo(id){
             // ojo aca se busca por id de la tabla pagos
             axios.get('/pagos/obtenerrbo/'+id)
                  .then(res=>{
                      this.Rbo = res.data.reg
                      this.Rbo.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                      this.Rbo = this.Rbo[0]
                          this.RboEditar = this.rbos.filter(row=>row.id==id)[0]
                      })
         },
         obtenerNuevoNombre(idvta){
             //busco el nombre del cliente al que se le pasa el recibo
             if(idvta!=this.RboEditar.idvta){
             axios.get('/pagos/obtenernuevonombre/'+idvta)
                  .then(res=>{
                      this.nuevoNombre = res.data.nombre
                  })
             }
         },
         validarEdicionRbo(){
             if(this.Rbo.fecha!=''&&this.Rbo.idvta!=''&&this.Rbo.imp!=''&&this.Rbo.rbo!=''&&this.Rbo.cobr!=''){
                 this.guardarEdicionRbo();
             }
         },
         guardarEdicionRbo(){
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/pagos/guardaredicionrbo',this.Rbo)
                                                                 .then(res=>{
                                                                     msgSuccess('El recibo fue editado con exito')
                                                                 })
         .catch(error=>msgError(error.requests.response))
     },
     borrarRbo(id){
                     Swal.fire({
            title: 'Â¿Esta seguro?',
            text: `Se borrara el recibo ${id}`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Si, borrarlo!'
            }).then((result) => {
            if (result.isConfirmed) {
                axios.get('/pagos/borrarrbo/'+id)
                     .then(res=>{
                         msgSuccess('Borrado!','El recibo ha sido borrado')
                         this.obtenerRegRbo(this.buscar)})
                     .catch(error=>msgError('No se pudo borrar.'))
            }})
     },
     }}
 </script>
{% endblock %}

{% extends "base_template.html" %}

{% block title %}Clientes{% endblock %}
{% block style %}
<style>
 .articulos{
    background-color: lightyellow;
    color:black;
}
caption{
    caption-side: top;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
<div id="app">
    <div class="buttons">
        <div v-for="historico in historial">
            <button class="button is-outlined is-primary" @click="buscaCuentaporDni(historico[0])">|historico[1].slice(0,18)|</button>
        </div>
    </div>
      <div class="columns">
          <div class="column is-8">
            <div class="field is-horizontal">
                <input type="search" placeholder="Buscar en Romitex" size="73" class="input" v-model="buscar" @keyup.enter="buscarCliente" @focus="buscar='';verCard=false">
                <button type="button" @click="buscarCliente" class="button is-primary">Buscar</button>
              </div>
          </div>
      </div>

    <div class="buttons" v-if="buscar">
        <div v-for="cliente in clientes">
            <!-- [dni,nombre,direccion] -->
        <button class="button is-info" @mouseover="buscar=cliente[2]" @click="buscaCuentaporDni(cliente[0])">|cliente[1]|</button>
        </div>
    </div>
    <!-- card datos clientes -->
    <div class="block"  v-if="verCard">
        <div class="card mt-2" style="width: 52rem;">
            <div class="card-header">
              <div class="card-header-title">
                <p class="title is-2">|nombre|  |dni|</p>
              </div>
            </div>
              <div class="card-content">
                <p class="subtitle is-4">|calle+' '+num|  |barrio|  zona:|zona|</p>
                <p class="">tel:|tel| wapp:|wapp|</p>
                <p class="" v-if="acla"><span class="tag is-info" >acla  </span>|acla|</p>
                <p class="" v-if="mjecobr"><span class="tag is-danger " >mjecobr  </span>|mjecobr|</p>
                <p class="" v-if="horario"><span class="tag is-info " >horario  </span>|horario|</p>
                <p class="" v-if="infoseven"><span class="tag is-success " >infoseven  </span>|infoseven|</p>
                <div class="buttons">
                    
                    <button class="button is-danger " v-if="novendermas">|novendermas|</button>
                    <button class="button is-success " v-if="sev">|sev|</button>
                    <button class="button is-info " v-if="subirseven">|subirseven|</button>
                    <button class="button is-danger " v-if="mudo">|mudo|</button>
                    <button class="button is-warning " v-if="gestion">|gestion|</button>
                    <button class="button is-danger " v-if="incobrable">|incobrable|</button>
                    <button class="button is-info " v-if="seguir">|seguir|</button>
                    <button class="button is-primary " v-if="llamar">|llamar|</button>
                </div>
                <div class="columns field is-horizontal">
                    <div class="column is-2">
                        <span class="tag is-danger is-large" >PmoVto</span>
                    </div>
                    <div class="column is-3">
                        <input type="date" v-model="pmovto" size="12" class="input is-narrow">
                    </div>
                    <div class="column is-2">
                        <button class="button is-outlined is-success" @click="fecharPmoVto">Fechar</button>
                    </div>
                    <div class="column is-3">
                        <button class="button is-info ">Deuda $|deuda|</button>
                    </div>
                    <div class="column is-2">
                        <button type="button" class="button is-primary" data-toggle="modal" data-target="#staticBackdrop" @click="editarDatos">Editar</button>
                    </div>
                </div>
                </div>
          </div>
    </div>
    <!-- botonera funcional -->
    <div class="block" v-if="verCard">
        <button class="button is-outlined is-info is-small" @click="verVentas=!verVentas">Ver Ventas</button>
        
        <button class="button is-outlined is-warning is-small" @click="imprimirFicha">Impr Ficha</button>
        <a href="#" class="button is-outlined is-warning is-small">Intimar</a>
        <button class="button is-outlined is-success is-small" @click="cargarWapp">Wapp</button>
        <button class="button is-outlined is-success is-small" @click="cargarDatos">Datos</button>
        <button class="button is-outlined is-danger is-small" @click="toggleSube">SUBE</button>
        <button class="button is-outlined is-danger is-small"@click="toggleGestion">Gestion</button>
        <button class="button is-outlined is-danger is-small"@click="toggleMudado">Mudado</button>
        <button class="button is-outlined is-danger is-small"@click="toggleInc">INC</button>
        <button class="button is-outlined is-danger is-small"@click="toggleLN">LN</button>
        <button class="button is-outlined is-danger is-small"@click="toggleLlamar">Llamar</button>
        <button class="button is-outlined is-danger is-small"@click="toggleSeguir">Seguir</button>
        
    </div>
    <!-- tabla ventas -->
    <div class="block" v-if="verCard">
        <table class="table table-sm">
            <thead >
                <tr @click="!verVentas">
                <th>Id</th>
                <th>fecha</th>
                <th>plan</th>
                <th>DEBE</th>
                <th>Compra</th>
                <th>vdor</th>
                <th>info</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="venta in ventas" v-if="venta[3]||verVentas">
                <td><button class="button is-outlined is-primary is-small" @click="toggleVerArticulos(venta[0])">|venta[0]|</button></td>
                <td>|venta[1]|</td>
                <td>|venta[2]|</td>
                <td>$|venta[3]|</td>
                <td>$|venta[4]|</td>
                <td>|venta[5]|</td>
                <td>
                    <button class="button is-danger is-small" v-if="venta[6]">|venta[6]|</button>
                    <button class="button is-success is-small" v-if="venta[7]">|venta[7]|</button>
                    <button class="button is-primary is-small" v-if="venta[8]">|venta[8]|</button>
                </td>
                </tr>
            </tbody>
        </table>
    </div>
    <!-- tabla cuotas a pagar -->
    <div class="field is-horizontal" v-if="verCard" >
        <table class="table table-sm"  style="width: 300px;">
            <caption>Cuotas a pagar</caption>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Fecha</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="cuota in cuotas">
                    <td>|cuota[0]|</td>
                    <td>|cuota[1]|</td>
                    <td>$|cuota[2]|</td>
                </tr>
            </tbody>
        </table>
        <!-- tabla cuotas pagadas -->
        <table class="table table-sm ml-5"  style="width: 300px;">
            <caption>Pagos Realizados</caption>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Rbo</th>
                    <th>Imp</th>
                    <th>Rec</th>
                    <th>Cobr</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="pagada in pagadas">
                    <td>|pagada[0]|</td>
                    <td>|pagada[1]|</td>
                    <td>$|pagada[2]|</td>
                    <td>$|pagada[3]|</td>
                    <td>|pagada[4]|</td>
                </tr>
            </tbody>
        </table>
    </div>
    <!-- tabla comentarios -->
    <div class="block" v-if="verCard && comentarios.length">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Comentario</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="comentario in comentarios">
                    <td>|comentario[0]|</td>
                    <td>|comentario[1]|</td>
                </tr>
            </tbody>
        </table>
    </div>

  <!-- Modal Edicion de datos Clientes -->
  <div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1"        aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">Editar Datos Cliente</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group col-md-1">
                    <label for="sex">Sexo</label>
                    <input type="text" class="form-control" name="sex" v-model="sexo" value="">
                  </div>
                  <div class="form-group col-md-2">
                    <label for="dni">DNI</label>
                    <input type="text" class="form-control" name="dni" v-model="dni" value="">
                  </div>
                <div class="form-group col-md-5">
                  <label for="nombre">Nombre</label>
                  <input type="text" class="form-control" name="nombre" v-model="nombre" value="">
                </div>
                <div class="form-group col-md-2">
                  <label for="tel">Tel</label>
                  <input type="text" class="form-control" name="tel" v-model="tel" value="">
                </div>
                <div class="form-group col-md-2">
                  <label for="wapp">WhasApp</label>
                  <input type="text" class="form-control" name="wapp" v-model="wapp" value="">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-4">
                  <label for="calle">Calle</label>
                  <input type="text" class="form-control" name="calle" v-model="calle" list="callelist" autocomplete="off">
                  <datalist id="callelist">
                    <option v-for="calle in calles">|calle[0]|</option>
                </datalist>
                </div>
                <div class="form-group col-md-1">
                    <label for="num">Num</label>
                    <input type="text" class="form-control" name="num" v-model="num" >
                  </div>
                  <div class="form-group col-md-4">
                    <label for="barrio">Barrio</label>
                    <input type="text" class="form-control" name="barrio" v-model="barrio" list="barriolist" autocomplete="off">
                    <datalist id="barriolist">
                        <option v-for="barrio in barrios">|barrio[0]|</option>
                    </datalist>
                  </div>
                <div class="form-group col-md-3">
                  <label for="zona">Zona</label>
                  <input type="text" class="form-control" name="zona" v-model="zona" list="zonalist" autocomplete="off">
                  <datalist id="zonalist">
                    <option v-for="zona in zonas">|zona[0]|</option>
                </datalist>
                </div>
            </div>
            <div class="form-row">
                  <div class="form-group col-md-3">
                    <label for="acla">Aclaracion</label>
                    <input type="text" class="form-control" name="acla" v-model="acla" value="">
                  </div>
                  <div class="form-group col-md-3">
                    <label for="horario">Horario</label>
                    <input type="text" class="form-control" name="horario" v-model="horario" value="">
                  </div>
                  <div class="form-group col-md-3">
                    <label for="mjecobr">MjeCobr</label>
                    <input type="text" class="form-control" name="mjecobr" v-model="mjecobr" value="">
                  </div>
                <div class="form-group col-md-3">
                  <label for="infoseven">InfoSeven</label>
                  <input type="text" class="form-control" name="infoseven" v-model="infoseven" value="">
                </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" @click="guardarEdicion">Guardar</button>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>
</div>
{% endblock %}
{% block script %}
<script>
function textToClipboard (text) {
    var dummy = document.createElement("textarea");
    document.body.appendChild(dummy);
    dummy.value = text;
    dummy.select();
    document.execCommand("copy");
    document.body.removeChild(dummy);
}

const app = new Vue({
    el:"#app",
    delimiters:['|','|'],
    data:{
        verCard:false,
        buscar:'',
        clientes: [],
        sexo:'',
        dni:'',
        nombre:'',
        calle:'',
        num:'',
        direccion:'',
        barrio:'',
        tel:'',
        wapp:'',
        zona:'',
        acla:'',
        horario:'',
        mjecobr:'',
        infoseven:'',
        pmovto:'',
        deuda:'',
        sev:'',
        incobrable:'',
        mudo:'',
        llamar:'',
        gestion:'',
        subirseven:'',
        novendermas:'',
        seguir:'',
        ventas:[],
        verVentas:false,
        articulos:[],
        cuotas:[],
        pagadas:[],
        historial:[],
        calles:[],
        barrios:[],
        zonas:[],
        comentarios:[],


    },
    methods: {
        buscarCliente(){
            axios.get('/buscador/'+this.buscar)
            .then(res=>{
                this.clientes = res.data.clientes
                if(this.clientes.length==1) this.buscaCuentaporDni(this.clientes[0][0])
            })
        },
        buscaCuentaporDni(dni){
            axios.get('/buscador/'+dni)
            .then(res=>{
                /* dni[0],nombre[1],calle[2],num[3],barrio[4],tel[5],wapp[6],zona[7],pmovto[8],deuda[9]
                ,sev[10],incobrable[11],gestion[12],subirseven[13],novendermas[14],seguir[15],
                mudo[16],llamar[17],acla[18],horario[19],mjecobr[20],infoseven[21],sex[22] */
                this.clientes = res.data.clientes
                this.dni = this.clientes[0][0]
                this.nombre = this.clientes[0][1]
                this.calle = this.clientes[0][2]
                this.num = this.clientes[0][3]
                this.direccion = this.calle+' '+this.num
                this.barrio = this.clientes[0][4]
                this.tel = this.clientes[0][5]
                this.wapp = this.clientes[0][6]
                this.zona = this.clientes[0][7]
                this.pmovto = dayjs.utc(this.clientes[0][8]).format('YYYY-MM-DD')
                this.deuda = this.clientes[0][9]
                this.sev = this.clientes[0][10]==1?'Seven':null
                this.incobrable = this.clientes[0][11]==1?'INCOBRABLE':null
                this.gestion = this.clientes[0][12]==1?'Gestion':null
                this.subirseven = this.clientes[0][13]==1?'SUBE':null
                this.novendermas = this.clientes[0][14]==1?'NV+':null
                this.seguir = this.clientes[0][15]==1?'Seguir':null
                this.mudo = this.clientes[0][16]==1?'MUDO':null
                this.llamar = this.clientes[0][17]==1?'Llamar':null
                this.acla = this.clientes[0][18]
                this.horario = this.clientes[0][19]
                this.mjecobr = this.clientes[0][20]
                this.infoseven = this.clientes[0][21]
                this.sexo = this.clientes[0][22]

                this.verCard = true;
                this.buscar = '';
                this.clientes = [];
                this.pedirVentas(this.dni)
                this.pedirComentarios(this.dni)

                //botones de historial
                let agregar=true;
                this.historial.forEach(row=>{
                    if(row[1]==this.nombre) agregar=false
                })
                if(this.historial.length>3 && agregar) {
                    this.historial.unshift([this.dni,this.nombre])
                    this.historial.pop()
                }
                if(this.historial.length<=3 && agregar) {
                    this.historial.unshift([this.dni,this.nombre])
                }
            })
        },
        pedirVentas(dni){
            axios.get('/buscador/pedirventas/'+dni)
            .then(res=>{
                //console.log(res.data.ventas);
                arrayVentas = Array.from(res.data.ventas)
                let arrayTblVtas = []
                arrayVentas.forEach(vta=>{
                    /* id,fecha,cc,ic,p,idvdor,saldo,comprado,pp,pcc,pic,pper,devuelta,condonada */
                    let array = []
                    array.push(vta[0])
                    array.push(dayjs.utc(vta[1]).format('YYYY-MM-DD'))
                    if(vta[8]==0){
                        array.push(`${vta[2]} cuotas ${vta[4]==1?'MEN':'SEM'} de $${vta[3]}`)
                    }else{
                        array.push(`${vta[9]} cuotas ${vta[11]==1?'MEN':'SEM'} de $${vta[10]}`)
                    }
                    array.push(vta[6])
                    array.push(vta[7])
                    array.push(vta[5])
                    array.push(vta[8]==1?'PLAN DE PAGO':null)
                    array.push(vta[12]==1?'DEVUELTA':null)
                    array.push(vta[13]==1?'CONDONADA':null)
                    arrayTblVtas.push(array)
                })
                //console.log(arrayTblVtas);
                this.ventas=arrayTblVtas;
                this.pedirCuotas(dni)
            })
        },
        pedirComentarios(dni){
            axios.get('/buscador/pedircomentarios/'+dni)
            .then(res=>{
                //console.log(res.data.comentarios);
                arrayComentarios = Array.from(res.data.comentarios)
                arrayComentarios.forEach(row=>{
                    row[0]=dayjs.utc(row[0]).format('YYYY-MM-DD')
                })
                this.comentarios=arrayComentarios
            })
        },
        toggleVerArticulos(idvta){
            if(this.buscarRowArticulos(idvta)){
                this.borrarRowArticulos(idvta)
            }else{
                this.muestraArt(idvta)
            }
        },
        borrarRowArticulos(idvta){
            let $tbody = document.querySelector('tbody')
            arrayRows = Array.from($tbody.children)
            arrayRows.forEach(row=>{
                if(row.classList.contains(idvta)){
                    row.remove();
                }
            })
        },
        buscarRowArticulos(idvta){
            let $tbody = document.querySelector('tbody');
            let value;
            arrayRows = Array.from($tbody.children)
            arrayRows.forEach(row=>{
                if (row.classList.contains(idvta)==true){
                    value =  true;
                }
            })
            return value;
        },
        muestraArt(idvta){
            axios.get('/buscador/pedirarticulos/'+idvta)
            .then(res=>{
                //console.log(res.data.articulos);
                this.articulos=res.data.articulos

                let $tbody = document.querySelector('tbody');
                let rowInd;
                arrayRows = Array.from($tbody.children)
                arrayRows.forEach(row=>{
                    if(row.innerHTML.includes(idvta)){
                        rowInd = row.rowIndex
                    }
                })
                for(let articulo of this.articulos){
                    //console.log(articulo);
                    let $row = $tbody.insertRow(rowInd)
                    $row.classList.add(idvta)
                    $row.classList.add('articulos')
                    let $cell0 = $row.insertCell(0);
                    let $cell1 = $row.insertCell(1);
                    let $cell2 = $row.insertCell(2);
                    $cell1.colSpan = "2"
                    $cell0.innerHTML = articulo[0];
                    $cell1.innerHTML = articulo[1];
                    $cell2.innerHTML = articulo[2];
                }
            //console.log(this.buscarRowArticulos(idvta));
            })


        },
        pedirCuotas(dni){
            axios.get('/buscador/pedircuotas/'+dni)
            .then(res=>{
                //console.log(res.data.cuotas);
                /* nc,vto,ic */
                arrayCuotas = Array.from(res.data.cuotas)
                arrayCuotas.forEach(row=>{
                    row[1]=dayjs.utc(row[1]).format('YYYY-MM-DD')
                })
                this.cuotas=arrayCuotas;
                arrayPagadas = Array.from(res.data.pagadas)
                arrayPagadas.forEach(row=>{
                    row[0]=dayjs.utc(row[0]).format('YYYY-MM-DD')
                })
                this.pagadas=arrayPagadas;
            })
        },
        fecharPmoVto(){
            axios.get('/buscador/fecharpmovto/'+this.dni+'/'+this.pmovto)
            .then(res=>{
                //console.log(res);
                let toast = this.$toasted.success("PmoVto actualizado con exito", {
                theme: "outline",
                position: "top-right",
                duration : 3000,
                fullWidth: true,
            });
            })
        },
        cargarWapp(){
            let text,
                messaje;
            axios.get('/buscador/datosultvta/'+this.dni)
            .then(res=>{
                let fecha = res.data.ultvta[0][0];
                let articulos = res.data.ultvta[0][1];
                if (this.sev=='Seven'){
                text=
                `Nos comunicamos de la empresa ROMITEX por una deuda que usted tiene con la firma. Usted fue subido al SEVEN hasta regularizar su cuenta. Puede hacer un plan de pagos. Consulte por Wapp. Una vez cancelado en 24hs se lo elimina del SEVEN. De no desmostrar interes nos vemos obligados a cobrar su pagare por via JUDICIAL. Atte. *Departamento de cobranzas de ROMITEX*`
                } else {
                    text=
                    `Nos comunicamos de la empresa ROMITEX por una deuda que usted tiene con la firma. En los proximos dias deberemos informar al SEVEN el atraso de su cuenta. Le proponemos un plan de pagos que podemos realizar por este medio.`
                }
                messaje = this.nombre.concat(': ',text,' ',`(Por compra de ${articulos} realizada en '${this.direccion}' el dia ${dayjs.utc(fecha).format('DD-MM-YYYY')})`)
                //console.log(messaje);
                textToClipboard(messaje)
                let toast = this.$toasted.success("Notificacion copiada en el portapapeles", {
                theme: "outline",
                position: "top-right",
                duration : 3000,
                fullWidth: true,
                });
            })
        },
        cargarDatos(){
            let text = this.dni+'\n'+this.direccion+'\n'+this.barrio+'\n'+this.wapp
            textToClipboard(text)
                let toast = this.$toasted.success("Datos copiados en el portapapeles", {
                theme: "outline",
                position: "top-right",
                duration : 3000,
                fullWidth: true,
                });
        },
        toggleSube(){
            axios.get('/buscador/togglesube/'+this.dni)
            .then(res=>{
                this.buscaCuentaporDni(this.dni)
            })
        },
        toggleGestion(){
            axios.get('/buscador/togglegestion/'+this.dni)
            .then(res=>{
                this.buscaCuentaporDni(this.dni)
            })
        },
        toggleMudado(){
            axios.get('/buscador/togglemudado/'+this.dni)
            .then(res=>{
                this.buscaCuentaporDni(this.dni)
            })
        },
        toggleInc(){
            axios.get('/buscador/toggleinc/'+this.dni)
            .then(res=>{
                this.buscaCuentaporDni(this.dni)
            })
        },
        toggleLN(){
            axios.get('/buscador/toggleln/'+this.dni)
            .then(res=>{
                this.buscaCuentaporDni(this.dni)
            })
        },
        toggleLlamar(){
            axios.get('/buscador/togglellamar/'+this.dni)
            .then(res=>{
                this.buscaCuentaporDni(this.dni)
            })
        },
        toggleSeguir(){
            axios.get('/buscador/toggleseguir/'+this.dni)
            .then(res=>{
                this.buscaCuentaporDni(this.dni)
            })
        },
        editarDatos(){
            console.log('editando datos');
        },
        getTablas(){
            axios.get('/buscador/gettablas')
            .then(res=>{
                //console.log(res.data.calles);
                this.calles=res.data.calles
                this.barrios=res.data.barrios
                this.zonas=res.data.zonas
            })
        },
        guardarEdicion(){
            axios({
                method:'POST',
                url:'/buscador/editardatos/'+this.dni,
                data:{
                    sex:this.sexo,
                    dni:this.dni,
                    nombre:this.nombre,
                    calle:this.calle,
                    num:this.num,
                    barrio:this.barrio,
                    zona:this.zona,
                    tel:this.tel,
                    wapp:this.wapp,
                    acla:this.acla,
                    mjecobr:this.mjecobr,
                    horario:this.horario,
                    infoseven:this.infoseven,
                }
            })
            .then(res=>{
                console.log(res);
                let toast = this.$toasted.success("Edicion realizada con exito", {
                theme: "outline",
                position: "top-right",
                duration : 3000,
                fullWidth: true,
                });
            })

        },
        imprimirFicha(){
            let ids = [];
            ids.push(this.dni);
            axios({
                method:"POST",
                url:"/buscador/imprimirficha",
                responseType: "blob",
                data: ids,
            }).then((res)=>{
                let url = window.URL.createObjectURL(res.data);
                window.open(url);
            })

        }
    },

    created: function(){
        this.getTablas();
    },

})

</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Barrios{% endblock %}
{% block style %}
<style>
</style>
{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="getBarrios()">

  <p class="title is-1">Gestion de Barrios</p>

  <div class="columns">
    <div class="column is-4">
      <div class="grid-buscar  mr-3 mt-2">
        <input type="search" placeholder="Filtrar:" class="input" x-model="buscar"
		       @focus="buscar=''" @keyup.enter="filtrarBarrio(buscar)" autofocus
               :class="darkTheme?'input-dark':''">
    <button type="button" @click="filtrarBarrio(buscar)" class="button is-primary">Buscar</button>
  </div>
    </div>
  </div>


  <button class="button is-primary" @click="toggleModal('modal-add')">Agregar Barrio</button>
  <table class="table is-narrow nototal" style="width:430px;">
    <thead>
      <tr>
        <th></th>
        <th></th>
        <th class="numeric">id</th>
        <th>barrio</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="barrio in listaBarrios_">
        <tr>
          <td><i class="fa fa-times" aria-hidden="true" @click="borrarBarrio(barrio.id)"></td>
            <td><i class="fa fa-pencil" aria-hidden="true" @click="editarBarrio(barrio.id)"></td>
              <td x-text="barrio.id"></td>
              <td x-text="barrio.barrio"></td>
        </tr>
      </template>
    </tbody>
  </table>

    <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}" />
    <!-- modal Bulma -->
    <div class="modal" id="modal-edicion">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Edicion de Barrio</p>
                <button class="delete" aria-label="close" @click="toggleModal('modal-edicion')"></button>
            </header>
            <section class="modal-card-body">
                <!-- Content ... -->
              <label for="idbarrio">Barrio</label>
              <input name="idbarrio" class="input" type="text" x-model="barrioEditar.barrio" />

            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" @click="guardarEdicion()">Editar</button>
                <button class="button" @click="toggleModal('modal-edicion')">Cancelar</button>
            </footer>
        </div>
    </div>

    <div class="modal" id="modal-add">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Agregar Barrio</p>
                <button class="delete" aria-label="close" @click="toggleModal('modal-add')"></button>
            </header>
            <section class="modal-card-body">
                <!-- Content ... -->
              <label for="idbarrio">Barrio</label>
              <input name="idbarrio" class="input" type="text" x-model="Barrio.barrio" />

            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" @click="guardarBarrio()">Agregar</button>
                <button class="button" @click="toggleModal('modal-add')">Cancelar</button>
            </footer>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
 function main(){
     return{
         listaBarrios:[],
         listaBarrios_:[],
         barrioEditar:{},
         Barrio:{},
         buscar:'',
         getBarrios(){
             axios.get('/ventas/getbarriosconid')
                  .then(res=>{
                      this.listaBarrios = res.data.barrios
                      this.listaBarrios_ = this.listaBarrios
                  })
         },
         borrarBarrio(id){
            Swal.fire({
            title: 'Â¿Esta seguro?',
            text: `Se borrara el barrio ${id}`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Si, borrarlo!'
            }).then((result) => {
            if (result.isConfirmed) {
                axios.get('/ventas/borrarbarrio/'+id)
                     .then(res=>{
                         msgSuccess('Borrado!','El registro ha sido borrado')
                         this.getBarrios()})
                     .catch(error=>msgError('No se pudo borrar. Posiblemente haya registros con ese barrio.'))
                }})
         },
         editarBarrio(id){
             this.barrioEditar = this.listaBarrios.filter(row=>row.id==id)[0]
             toggleModal('modal-edicion')

         },
         guardarEdicion(){
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             toggleModal('modal-edicion')
             axios.post('/ventas/guardaredicionbarrio',this.barrioEditar)
                                                                 .then(res=>{
                                                                     this.getBarrios()
                                                                     msgSuccess('Edicion procesada con exito')
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError('Edicion no se pudo procesar')
                                                                 })
         },
         guardarBarrio(){
             toggleModal('modal-add')
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/ventas/guardarbarrionueva',this.Barrio)
                                                                 .then(res=>{
                                                                     this.getBarrios()
                                                                     this.Barrio={}
                                                                     msgSuccess('Barrio agregado con exito')
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError('No se pudo agregar el barrio')
                                                                 })
         },
                    filtrarBarrio(buscar){
                        this.listaBarrios_=this.listaBarrios.filter(row=>row.barrio.toLocaleLowerCase().includes(buscar.toLocaleLowerCase()))
                    },

     }
 }
</script>
{% endblock %}

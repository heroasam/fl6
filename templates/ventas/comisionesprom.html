{% extends "base.html" %}

{% block title %}Comisiones promotoras{% endblock %}
{% block style %}
<style>
  </style>
  {% endblock %}

{% block content %}

  <div class="container" x-data="main()" x-init="getComisionesProm()">

    <p class="title is-1">Comisiones Promotoras</p>
    <div class="columns">
      <div class="column is-6">

         <div class="xtags has-addons m-0" x-show="totalComision">
		  <span class="tag is-large is-black m-0">Comision Cada Una</span>
		  <span class="tag is-large is-light m-0" x-text="'$'+totalComision/2"></span>
	     </div>
         <table class="table is-narrow" id="table">
                <thead>
                  <tr>
                    <th></th>
                      <th>fecha</th>
                      <th>cnt</th>
                      <th class="sumar">comision</th>
                    </tr>
                </thead>
                <tbody>
                   <template x-for="item in listaFechas">
                    <tr :id="item.fecha">
                      <td><span class="icon is-small"><i class="fa fa-plus-square-o" aria-hidden="true"
                                                         @click="expandChildren(item.fecha)"></td>
                          <td x-text="item.fecha"></td>
                          <td x-text="item.cnt"></td>
                          <td x-text="item.comision" class="pesos"></td>
                    </tr>
                   </template>
                   <template x-for="item in listaComisiones_">
                    <tr class="children">
                      <td x-text="item.id"></td>
                      <td x-text="item.com" class="pesos"></td>
                    </tr>
                  </template>
                 </tbody>
            </table>
            <button class="button is-danger" @click="validarPagado()">Pagado</button>
            <button class="button is-danger" @click="validarPagadoSeleccionados()">Pagado dias seleccionados</button>
            <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>

    </div>


</div>
{% endblock %}

{% block script %}
<script>
 function main(){
     return{
         listaComisiones:[],
         listaComisiones_:[],
         totalComision:'',
         listaFechas:[],
         fecha:'',
         Procesar:{},
         getComisionesProm(){
             axios.get('/vendedor/getcomisionesprom')
                  .then(res=>{
                      this.listaComisiones = res.data.comisiones
                      this.listaComisiones.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                      this.listaComisiones.map(row=>row.com=parseFloat(row.com))
                      this.totalComision = parseFloat(this.listaComisiones.map(row=>row.com).reduce((a,b)=>a+b,0))
                      this.listaFechas = res.data.fechascomisiones
                      this.listaFechas.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                      this.listaFechas.map(row=>row.comision=parseFloat(row.comision))
                      console.log( this.listaComisiones, this.listaFechas)
                  })
         },
         validarPagado(){
           Swal.fire({
            title: '¿Esta seguro?',
            text: `Se marcara como pagadas las comisiones de promotoras`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Si, Marcarlas!'
            }).then((result) => {
            if (result.isConfirmed) {
                axios.get('/vendedor/marcarpagadascomprom')
                     .then(res=>{
                         msgSuccess('Marcado!','Las promotoras han cobrado lo que hay hasta el momento')
                         this.getComisionesProm()})
                     .catch(error=>msgError('No se pudo procesar. Hubo un error.'))
            }})
         },
         expandChildren(fecha){
              if(this.fecha==fecha && this.listaComisiones_.length>0){
                  this.listaComisiones_ = []
                  return
              }
             this.listaComisiones_ = this.listaComisiones.filter(row=>row.fecha==fecha)
             this.fecha = fecha
             setTimeout(()=>{
             $tbody = document.querySelector('tbody')
             $trfecha = document.getElementById(fecha)
             let arrayrows = Array.from($tbody.children)
             let children = arrayrows.filter(row=>row.classList.contains('children'))
             children = children.reverse()
             for(el of children){
                 $tbody.insertBefore(el,$trfecha.nextSibling)
             }},10)
         },
         cuentaSeleccionados(){
             let arraySeleccionados = []
			 const $tbody = document.querySelector("tbody");
        	 arrayRows = Array.from($tbody.children);
        	 arrayRows.forEach((row) => {
                 if(row.classList.contains('is-selected')){
                     arraySeleccionados.push(row.cells[1].innerHTML)
                     //OJO la celda de las fechas
             }})
             return arraySeleccionados
         },
         validarPagadoSeleccionados(){
             this.Procesar.fechas = this.cuentaSeleccionados()
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value;
              Swal.fire({
            title: '¿Esta seguro?',
            text: `Se marcara como pagadas las comisiones de promotoras de los dias seleccionados`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Si, Marcarlas!'
            }).then((result) => {
            if (result.isConfirmed) {
                axios.post('/vendedor/marcarpagadascompromseleccionados',this.Procesar)
                     .then(res=>{
                         msgSuccess('Marcado!','Las promotoras han cobrado lo que hay hasta el momento')
                         this.getComisionesProm()
                         limpiarTabla('table')
                     })
                     .catch(error=>msgError('No se pudo procesar. Hubo un error.'))
            }})
         },

     }
 }
  </script>
  {% endblock %}

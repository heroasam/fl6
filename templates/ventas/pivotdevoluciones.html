{% extends "base.html" %}

{% block title %}Pivot devoluciones{% endblock %}

{% block content %}

<div class="container">

  <p class="title is-1">Devoluciones por mes de venta</p>
  <div  x-data="main()" x-init="getVentaUltYear()">
    {{tbl|safe}}
    <h3 class="title is-3 center">Devoluciones en porcentaje de Ventas</h3>
    <canvas id="grafico-estadistica" width="400" height="300"></canvas>

  </div>
</div>
{% endblock %}

{% block script %}
<script>
 function main(){
     return{
         ventas:[],
         devoluciones: [],
         porcdevolucion: [],
         index:[],
         getTotales(){
             let tableId = document.getElementById('pivotdevoluciones')
             let tbody = tableId.querySelector('tbody');
             let rowsArray = Array.from(tbody.rows);
             let rowIndex=[];
             rowsArray.forEach((row)=>{
                 rowIndex.push(row.rowIndex-1)
                 this.index.push( row.cells[0].innerText)
                 let sumaFila = 0
                 for(let i=1; i<row.cells.length;i++){
                     let valor = row.cells[i].innerText
                     valor = valor.replace('$','')
                     sumaFila += Number(valor)
                 }
                 this.devoluciones.push(sumaFila)
             });
             let maxRow = Math.max(...rowIndex)+1;
             let $rowTotal = tbody.insertRow(maxRow);
             let $cell0 = $rowTotal.insertCell(0);
             $cell0.innerHTML = "Total";
             $rowTotal.classList.add('total');

             const cols = rowsArray[0].children.length // determino la cant columnas
             for(let i=1;i<cols;i++){
                 let col = [];
                 rowIndex.forEach((ix)=>{
                     col.push(nop(tbody.rows[ix].cells[i].innerText))
                 });
                 let total = col.reduce((a,b)=>Number(a)+Number(b));
                 let $cell = $rowTotal.insertCell(i);
                 $cell.classList.add('pesos')
                 if (!(Number.isNaN(total))) $cell.innerHTML = total
             }
             for(let i=1;i<12;i++){
                 this.porcdevolucion[i] = this.devoluciones[i]/this.ventas[i]*100
             }
             rowsArray.forEach(row=>{
                 let newcell = row.insertCell()
                 newcell.innerHTML=this.devoluciones[row.rowIndex-1]
                 newcell.classList.add('pesos')
             })
             let celltotal = $rowTotal.insertCell()
             celltotal.innerHTML=this.devoluciones.reduce((a,b)=>Number(a)+Number(b))
             celltotal.classList.add('pesos')
         },
         getVentaUltYear(){
             axios.get('/ventas/obtenerventasultyear')
                  .then(res=>{
                      this.ventas=res.data.ventas
                      this.getTotales()
                      this.getGrafico()
                  })
         },
         getGrafico(){
             const canvas = document.getElementById('grafico-estadistica').getContext('2d');
             const chart = new Chart(canvas, {
		         type: 'bar',
		         data: {
                     labels: this.index,
                     datasets: [{
			             label: 'Devoluciones en Porcentaje de la Venta',
			             data: this.porcdevolucion,
			             order: 1,
			             backgroundColor: [
                             'rgba(255, 99, 132, 0.5)',
                             'rgba(54, 162, 235, 0.5)',
                             'rgba(255, 206, 86, 0.5)',
                             'rgba(75, 192, 192, 0.5)',
                             'rgba(153, 102, 255, 0.5)',
                             'rgba(255, 159, 64, 0.5)'
			             ],
			             borderColor: [
                             'rgba(255, 99, 132, 1)',
                             'rgba(54, 162, 235, 1)',
                             'rgba(255, 206, 86, 1)',
                             'rgba(75, 192, 192, 1)',
                             'rgba(153, 102, 255, 1)',
                             'rgba(255, 159, 64, 1)'
			             ],
			             borderWidth: 1
                     },

		             ]
		         },
		         options: {
                     scales: {
			             y: {
                             beginAtZero: true
			             }
                     }
		         }
             });
	 }}

 }


</script>
{% endblock %}

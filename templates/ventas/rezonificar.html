{% extends "base.html" %}

{% block title %}Rezonificar{% endblock %}
{% block style %}
<style>
</style>
{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="getZonas()">
  <p class="title is-1">Rezonificar</p>

  <div class="columns">
    <div class="column is-4">
      <div class="grid-buscar  mr-3 mt-2">
        <input type="search" placeholder="Filtrar por zona:" class="input " x-model="buscar"
		       @focus="buscar=''"  autofocus list="zonas" :class="darkTheme?'input-dark':''">
        <datalist id="zonas">
          <template x-for="item in listazonas">
            <option :value="item"></option>
          </template>
        </datalist>

        <button type="button" @click="filtrarZona(buscar)" class="button is-primary ">Buscar</button>
      </div>
    </div>
    <div class="column is-4">
      <div class="grid-buscar  mr-3 mt-2">
        <input type="search" placeholder="Cambiar por zona:" class="input " x-model="cambiar"
		       @focus="cambiar=''"  autofocus list="zonas" :class="darkTheme?'input-dark':''">
        <datalist id="zonas">
          <template x-for="item in listazonas">
            <option :value="item"></option>
          </template>
        </datalist>

        <button type="button" @click="cambiarZona(cambiar)" class="button is-danger ">Cambiar</button>
      </div>
    </div>
    <div class="column is-2">
      <button class="button is-danger " @click="borrarZona(buscar)">Borrar zona</button>
    </div>
  </div>

  <table class="table" id="table">
    <thead>
      <tr>
        <th></th>
        <th>id</th>
        <th>nombre</th>
        <th>calle</th>
        <th>num</th>
        <th>barrio</th>
        <th>zona</th>
        <th>deuda</th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <template x-for="cliente in listaClientes">
        <tr>
          <td><a :href="'/buscador/interno/'+cliente.dni" target="_blank">Ir</a></td>
          <td x-text="cliente.id"></td>
          <td x-text="cliente.nombre"></td>
          <td x-text="cliente.calle"></td>
          <td x-text="cliente.num"></td>
          <td x-text="cliente.barrio"></td>
          <td x-text="cliente.zona"></td>
          <td x-text="cliente.deuda"></td>
          <td><span class="tag is-small"  x-show="cliente.incobrable">INC</span></td>
          <td><span class="tag is-small"  x-show="cliente.novendermas">LN</span></td>
          <td><span class="tag is-small"  x-show="cliente.mudo">MUDO</span></td>
          <td><span class="tag is-small"  x-show="cliente.gestion">GESTION</span></td>
        </tr>
      </template>
    </tbody>
  </table>

  <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}" />
  <!-- modal Bulma --></div>
</div>
{% endblock %}

{% block script %}
<script>
 function main(){
     return{
         listazonas:[],
         listaClientes:[],
         buscar:'',
         cambiar:'',
         getZonas(){
             axios.get('/ventas/getzonas')
                  .then(res=>{
                      this.listazonas = res.data.result
                  })
         },
         filtrarZona(zona){
             axios.get('/ventas/getclienteszona/'+zona)
                  .then(res=>{
                      this.listaClientes = res.data.clientes
                  })
         },
         borrarZona(zona){
             Swal.fire({
                 title: 'Â¿Esta seguro?',
                 text: `Se borrara la zona ${zona}`,
                 icon: 'warning',
                 showCancelButton: true,
                 confirmButtonColor: '#3085d6',
                 cancelButtonColor: '#d33',
                 confirmButtonText: 'Si, borrarlo!'
             }).then((result) => {
                 if (result.isConfirmed) {
                     axios.get('/ventas/borrarzonapornombre/'+zona
                     )
                          .then(res=>{
                              msgSuccess('Borrado!','La zona ha sido borrada')
                              this.getZonas()})
                          .catch(error=>msgError('No se pudo borrar. Posiblemente haya registros con esa zona.'))
             }})
         },
         guardarZona(){
             toggleModal('modal-add')
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/ventas/guardarzonanueva',this.Zona)
                                                                 .then(res=>{
                                                                     this.getZonas()
                                                                     this.Zona={}
                                                                     msgSuccess('Zona agregada con exito')
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError('No se pudo agregar la zona')
                                                                 })
         },
         seleccionarRows(){
             let ids = [];
             let tbody = document.querySelector("tbody");
             let rowsArray = Array.from(tbody.rows);
             rowsArray.forEach((row) => {
                 if (row.classList.contains("is-selected")) {
                     ids.push(row.cells[1].innerHTML);
                     //la columna que corresponda al id OJO
                 }
             });
             return ids
         },
         cambiarZona(zona){
             let ids = this.seleccionarRows()
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/ventas/cambiarzona/'+zona,ids)
                                                                 .then(res=>{
                                                                     this.filtrarZona(this.buscar)
                                                                     limpiarTabla('table')
                                                                     msgSuccess("Zona cambiada")
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError(error.request.response)
                                                                 })
         },

     }
 }
</script>
{% endblock %}

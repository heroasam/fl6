{% extends "base.html" %}

{% block title %}Autorizar Datos{% endblock %}

{% block content %}

<div  x-data="main()" x-init="getListadoAutorizados();setInterval(()=>{getListadoAutorizados()},10000)">

  <div class="columns">
    <div class="column is-6">
      <div class="flex-space-between">
        <p class="title is-1">Autorizar Datos</p>
        <a class="tag is-info is-large" style="text-decoration:none;" href="/buscador/listaautorizados">Lista Autorizados</a>
      </div>
    </div>
    <div class="column is-6">
       <div class="flex-right">
    <button class="button is-primary" @click="cambiarCuotaBasica">Cambiar</button>
    <div class="xtags has-addons m-0">
		  <span class="tag is-warning is-large m-0">Cuota Basica</span>
		  <span class="tag is-light is-large m-0" x-text="'$'+cuota_basica"></span>
	</div>
       </div>
    </div>
  </div>


  <table class="table table-striped " id="table">
    <thead>
      <tr>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th>Id</th>
        <th>fecha</th>
        <th>nombre</th>
        <th>vendedor</th>
        <th>status</th>
        <th>articulos</th>
        <th>basica</th>
        <th>requerida</th>
        <th>autorizar</th>
        <th>rechazar</th>
        <th>anular</th>
        <th>arts</th>
        <th>hora</th>
        <th></th>
        <th></th>
        <th>direccion</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <template x-for="dato in listadoAutorizados_">
        <tr>
          <td><button class="button is-small is-warning" @click="toggleAtender(dato.id)" x-text="dato.tomado?'Atendido':'Atender'"
              :class="dato.tomado?'is-danger':'is-warning'"></button></td>
          <td><a :href="'/buscador/interno/'+dato.idcliente">Ver</a></td>
          <td><i class="fa fa-pencil" aria-hidden="true" @click="editarDato(dato.id)"></td>
            <td><button class="button is-small is-success" @click="copiarDNI(dato.idcliente)">Copiar DNI</button></td>
          <td x-text="dato.iddato"></td>
          <td x-text="dato.fecha"></td>
          <td x-text="dato.nombre"></td>
          <td x-text="dato.vendedor"></td>
          <td><span class="tag is-small" x-text="dato.resultado==1?'Vendido':(dato.resultado==0?'Anulado':
                           (dato.resultado==2?'Rechazado':(dato.resultado==5?'Mudo':(dato.resultado==6?'Fallecio':'Pendiente'))))"
                    :class="dato.resultado==1?'is-success':(dato.resultado==0?'is-danger':(dato.resultado==2?'is-warning':
                           (dato.resultado==5?'is-primary':(dato.resultado==6?'is-black':'is-info'))))"></span></td>
          <td x-text="dato.art"></td>
          <td x-text="dato.cuota_maxima"></td>
          <td x-text="dato.cuota_requerida"></td>
          <td><span class="tag is-small is-black" @click="motivoAutorizacion(dato.id)"
                    x-show="![0,1,2,5,6,8].includes(dato.resultado)">Motivo</span></td>
          <td><span class="tag is-small is-success" @click="autorizarDato(dato.id)"
                    x-show="![0,1,2,5,6,8].includes(dato.resultado)">Autorizar</span></td>
          <td><span class="tag is-small is-warning" @click="noAutorizarDato(dato.id)"
                    x-show="![0,1,2,5,6,8].includes(dato.resultado)">Rechazar</span></td>
          <td><span class="tag is-small is-danger" @click="rechazarDato(dato.id)"
                    x-show="![0,1,2,5,6,8].includes(dato.resultado)">Anular</span></td>
          <td x-text="dato.arts"></td>
            <td x-text="dato.fechahora"></td>
            <td><span class="tag is-small is-danger" x-show="dato.sin_extension">Venta Basica</span>
              <span class="tag is-small is-warning" x-show="dato.nosabana">NoSabana</span></td>
            <td><div class="xtags has-addons m-0" x-show="dato.deuda_en_la_casa">
		      <span class="tag is-warning  m-0">Casa</span>
		      <span class="tag is-light  m-0" x-text="'$'+dato.deuda_en_la_casa"></span>
	        </div></td>
            <td><span class="tag is-danger" x-show="dato.comentarios=='cliente enviado por vendedor'">Ver primero el cliente ingresado</span></td>
            <td><span class="tag is-small is-danger" x-show="dato.novendermas">LN</span>
            <span class="tag is-small is-danger" x-show="dato.incobrable">INC</span>
            <span class="tag is-small is-success" x-show="dato.sev">SEVEN</span>
            <span class="tag is-small is-success" x-show="dato.baja">ex-SEVEN</span></td>
            <td><span class="tag is-small is-danger" x-show="dato.cnt>1" @click="mostrarAutorizados(dato.idcliente)"
                >Mostrar otras autorizaciones</span></td>
        </tr>
      </template>
    </tbody>
  </table>

   <!-- bulma-modal editar-dato  -->
  <div class="modal" id="modal-editar-dato">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Editar Dato</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-editar-dato')"></button>
        <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="idfecha">Fecha</label>
        <input type="date" class="input mb-3" x-model="Datos.fecha" id="idfecha"
               :class="darkTheme?'input-dark':''" >
        <label for="idfechavisitar">Fecha a Visitar (opcional)</label>
        <input type="date" class="input mb-3" x-model="Datos.fecha_visitar" id="idfechavisitar"
               :class="darkTheme?'input-dark':''" >
        <label for="art" class="label">Articulo (opcional)</label>
        <input type="text" class="input mb-3" x-model="Datos.art" id="art" autocomplete="off"
               :class="darkTheme?'input-dark':''" >
        <label for="horarios" class="label">Horarios (opcional)</label>
        <input type="text" class="input mb-3" x-model="Datos.horarios" id="horarios" autocomplete="off"
               :class="darkTheme?'input-dark':''" >
        <label for="comentarios" class="label">Comentarios (opcional)</label>
        <input type="text" class="input mb-3" x-model="Datos.comentarios" id="comentarios" autocomplete="off"
               :class="darkTheme?'input-dark':''" >
        <label for="cuota" class="label">Cuota Maxima</label>
        <input type="text" class="input mb-3" x-model="Datos.cuota_maxima" id="cuota" autocomplete="off"
               :class="darkTheme?'input-dark':''" >
         <div class="flex">
          <button class="button is-black" @click="nosabana=!nosabana; Datos.nosabana=nosabana">No Sabana</button>
          <p class="title is-3" x-show="nosabana==1">Este cliente no puede comprar sabanas</p>
        </div>
        <div class="flex">
          <button class="button is-black" @click="sin_extension=!sin_extension; Datos.sin_extension=sin_extension">Venta Basica</button>
          <p class="title is-3" x-show="sin_extension==1">Venta Basica</p>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" @click="guardarDato">Editar</button>
        <button class="button" @click="toggleModal('modal-editar-dato')">Cancelar</button>
      </footer>
    </div>
  </div>
   <!-- bulma-modal edicion-cuotabasica -->
  <div class="modal" id="modal-edicion-cuotabasica">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Fechar Cuotabasica</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-edicion-cuotabasica')"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="idcuotabasica">Cuota Basica</label>
        <input type="text" class="input mb-3" x-model="cuota_basica" id="idcuotabasica">
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" @click="guardarCuotabasica">Guardar</button>
        <button class="button" @click="toggleModal('modal-edicion-cuotabasica')">Cancelar</button>
      </footer>
    </div>
  </div>
   <!-- bulma-modal edicion-vendedor-asignado -->
  <div class="modal" id="modal-vendedor-asignado">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Enviar Datos a Vendedor</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-vendedor-asignado')"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <p class="title is-5" x-text="'Esta por enviar '+cntSeleccionados+' datos'"></p>
            <template x-for="vdor in listaVdores">
            <button class="button" x-text="vdor" @click="vendedorAsignado=vdor">
            </button>
            </template>
          <p class="title is-5" x-text="'Ud ha elegido el vendedor '+vendedorAsignado" x-show="vendedorAsignado"></p>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" @click="enviarDatosaVendedor">Enviar</button>
        <button class="button" @click="toggleModal('modal-vendedor-asignado')">Cancelar</button>
      </footer>
    </div>
  </div>
   <!-- bulma-modal motivo-autorizacion -->
  <div class="modal" id="modal-motivo-autorizacion">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Motivo autorizacion</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-motivo-autorizacion')"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="idmotivo">Motivo</label>
        <input type="text" class="input mb-3" x-model="motivo" id="idmotivo">
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" @click="guardarMotivo()">Guardar</button>
        <button class="button" @click="toggleModal('modal-motivo-autorizacion')">Cancelar</button>
      </footer>
    </div>
  </div>
</div>
{% endblock %}
{% block script %}
<script>
 function main(){
     return{
         dni:'',
         listadoAutorizados:[],
         listadoAutorizados_:[],
         listadoAutorizadosporid:[],
         Datos:{},
         cuota_basica:'',
         cntSeleccionados:'',
         vendedorAsignado:'',
         listaVdores:[],
         largo:'',
         ultlargo:0,
         audio:new Audio("{{ url_for('static', filename='auth.mp3') }}"),
         nosabana:0,
         sin_extension:0,
         motivo:'',
         idauth:'',
         getListadoAutorizados(){
             axios.get('/vendedor/getlistadoautorizados')
                  .then(res=>{
                      this.listadoAutorizados = res.data.listadoautorizados
                      this.listadoAutorizados.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                      this.listadoAutorizados.map(row=>row.fecha_visitar=dayjs.utc(row.fecha_visitar).format('YYYY-MM-DD'))
                      let diff = this.listadoAutorizados.filter(row=>row.diff=dayjs.utc().diff(dayjs.utc(row.fechahora),'s')-10800<61&&row.tomado==0) //pq ultimotime esta en GMT 3hs de diferencia
                      this.listadoAutorizados.map(row=>row.fechahora=dayjs.utc(row.fechahora).format('HH:mm'))
                      this.cuota_basica = res.data.cuotabasica
                      this.listadoAutorizados_ = this.listadoAutorizados
                      /* this.largo = this.listadoAutorizados.length
                       * if (this.largo>this.ultlargo){
                       *     this.audio.play();
                       *     this.ultlargo=this.largo
                       * } */
                      if(diff.length>0) this.audio.play()
                  })
         },
         mostrarAutorizados(idcliente){
             if(this.listadoAutorizadosporid.length==0){
             axios.get('/vendedor/getlistadoautorizadosporid/'+idcliente)
             .then(res=>{
                 this.listadoAutorizadosporid = res.data.listadoautorizadosporid
                 this.listadoAutorizadosporid.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                 this.listadoAutorizadosporid.map(row=>row.fecha_visitar=dayjs.utc(row.fecha_visitar).format('YYYY-MM-DD'))
                 this.listadoAutorizadosporid.map(row=>row.fechahora=dayjs.utc(row.fechahora).format('HH:mm'))
                 this.listadoAutorizados_ = this.listadoAutorizadosporid
             })}else{
                 this.listadoAutorizadosporid = []
                 this.listadoAutorizados_ = this.listadoAutorizados
             }
         },
         editarDato(id){
             this.Datos = this.listadoAutorizados.filter(row=>row.id==id)[0]
             this.nosabana = this.Datos.nosabana
             this.sin_extension = this.Datos.sin_extension
             toggleModal("modal-editar-dato")
             this.Datos.id = this.Datos.iddato
         },
         guardarDato(){
             toggleModal("modal-editar-dato")
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/vendedor/editardato',this.Datos)
                                                                 .then(res=>{
                                                                     msgSuccess('Dato editado con exito.')
                                                                     this.getListadoAutorizados()
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError('Hubo un error. El dato no se edito.')
             })
         },
         cambiarCuotaBasica(){
             toggleModal("modal-edicion-cuotabasica")
         },
         guardarCuotabasica(){
           toggleModal("modal-edicion-cuotabasica")
           axios.get('/vendedor/guardarcuotabasica/'+this.cuota_basica)
                .then(res=>{
                    msgSuccess('Cuota Basica editada')
                })
                .catch(error=>{
                    msgError('Error. No se pudo editar')
             })
         },
         rechazarDato(id){
             axios.get('/vendedor/togglerechazardato/'+id)
                  .then(res=>{
                      msgSuccess('toggle RECHAZADO')
                      this.getListadoDatos()
                  })
                  .catch(error=>{
                      msgError('Error. No se pudo hacer el cambio.')
             })
         },
         autorizarDato(idauth){
             axios.get('/vendedor/autorizardato/'+idauth)
                  .then(res=>{
                      msgSuccess('Dato autorizado')
                       //enviar un whatsapp al vendedor informando de la autorizacion.
             let msg = `AUTORIZADO para ${this.dato.nombre}
con una compra de ${this.dato.arts}
y una cuota de $${this.dato.cuota_requerida}.
Cargue de nuevo la operacion y procese la venta. Gracias.`
                      if(this.motivo!=''){
                          msg = msg + `
Motivo: ${this.motivo}`
                          this.motivo = ''
}
                      let data = {msg,vdor:this.dato.vendedor}
                      axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
	                  /* axios.post('/vendedor/wapprespauth',data) */
                      this.getListadoAutorizados()
                  })
         },
          noAutorizarDato(idauth){
             axios.get('/vendedor/noautorizardato/'+idauth)
                  .then(res=>{
                      msgWarning('Cuota rechazada','Se puede vender la cuota que ya tenia')
                       //enviar un whatsapp al vendedor informando del rechazo.
             let msg = `Autorizacion RECHAZADA para ${this.dato.nombre}
con una compra de ${this.dato.arts}
y una cuota de $${this.dato.cuota_requerida}.
Se puede vender hasta la cuota autorizada previamente. Gracias.`
if(this.motivo!=''){
     msg = msg + `
Motivo: ${this.motivo}`
     this.motivo = ''
 }
                      let data = {msg,vdor:this.dato.vendedor}
                      axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
	                  /* axios.post('/vendedor/wapprespauth',data) */
                      this.getListadoAutorizados()
                  })
          },
         rechazarDato(idauth){
             axios.get('/vendedor/rechazardato/'+idauth)
                  .then(res=>{
                      msgError('Dato anulado','NO SE PUEDE VENDER')
                       //enviar un whatsapp al vendedor informando del rechazo.
             let msg = `se ANULA el dato  para ${this.dato.nombre}
con una compra de ${this.dato.arts}
NO SE PUEDE VENDER!
Gracias.`
                      if(this.motivo!=''){
                          msg = msg + `
Motivo: ${this.motivo}`
                          this.motivo = ''
                      }
                      let data = {msg,vdor:this.dato.vendedor}
                      axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
	                  /* axios.post('/vendedor/wapprespauth',data) */
                      this.getListadoAutorizados()
                  })
         },
         copiarDNI(idcliente){
             axios.get('/vendedor/obtenerdni/'+idcliente)
                  .then(res=>{
                      let dni = res.data.dni
                      textToClipboard(dni)
                      msgSuccess("DNI copiado al portapapeles")
             })
         },
         toggleAtender(idauth){
                 axios.get('/vendedor/tomardato/'+idauth)
                  .then(res=>{
                      this.getListadoAutorizados()
                  })
         },
         motivoAutorizacion(idauth){
             toggleModal("modal-motivo-autorizacion")
             this.motivo = ''
             this.idauth = idauth

         },
         guardarMotivo(){
             toggleModal("modal-motivo-autorizacion")
             if(this.motivo!=''){
                 axios.get('/vendedor/motivoautorizacion/'+this.motivo+'/'+this.idauth)
                  .then(res=>{
                      msgSuccess('Motivo autorizacion guardado')
                  })
             }
         },

 }}

</script>
{% endblock %}

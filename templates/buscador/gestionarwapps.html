{% extends "base.html" %}

{% block title %}Gestionar WhatsApps{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="getNombresWapps()">

  <div class="flex-space-between">
    <p class="title is-1">Gestionar WhatsApps</p>
    <button class="button is-info" @click="getNombresWapps()">Actualizar</button>
  </div>

  <table class="table noselect is-narrow">
    <thead>
      <tr>
        <th></th>
        <th>fecha</th>
        <th>whatsapp</th>
        <th>nombre</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <template x-for="item in listaChats">
        //listaChats es un Array de wapps. 
        <tr :id="item.wapp">
          <td><span class="icon is-small"><i class="fa fa-plus-square-o" aria-hidden="true"
                @click="expandChildren(item.wapp)"></i></span></td>
          <td x-text="item.fecha"></td>
          <td x-text="item.wapp"></td>
          <td><template x-for="but in item.nombre">
              <span class="tag is-small is-primary pointer is-rounded" :class="item.cobr?'is-info':'is-primary'"
                x-text="but" @click="contestarWapp(item.wapp,but)"></span>
            </template></td>
          <td><span class="has-tooltip-top" data-tooltip="Respondido por Web-WhatsApp"><i class="fa fa-check-square-o"
                aria-hidden="true" @click="marcarRespondidoWappOficial(item.wapp,item.nombre)"></i></span></td>
        </tr>
      </template>
      <template x-for="item in listaWapps_">
        <tr class="children">
          <td></td>
          <td x-text="item.fecha"></td>
          <td x-text="item.msg"></td>
          <td x-text="item.user"></td>
        </tr>
      </template>
    </tbody>
  </table>



</div>
{% endblock %}
{% block script %}
<script>
  function main() {
    return {
      listaWapps: [],
      listaChats: [],
      listaWapps_: [],
      listaCobrWapps: [],
      nombresWapps: [],
      listaDiferentesNombres: [],
      wapp: '',
      getNombresWapps() {
        axios.get('/buscador/obtenernombreswapps')
          .then(res => {
            this.nombresWapps = [...res.data.nombreswapps, ...res.data.cobrwapps];
            this.listaCobrWapps = res.data.cobrwapps
            this.listaDiferentesNombres = new Map();
            this.nombresWapps.forEach(row => {
              let nombre = row.nombre;
              if (this.listaDiferentesNombres.has(row.wapp)) {
                let elemento = this.listaDiferentesNombres.get(row.wapp);
                elemento.push(nombre);
                this.listaDiferentesNombres.set(row.wapp, elemento);
              } else {
                this.listaDiferentesNombres.set(row.wapp, [nombre])
              }
            })
            this.getWapps()
          })
      },
      getWapps() {
        axios.get('/buscador/obtenertodoswapps')
          .then(res => {
            let recibidos = res.data.recibidos
            let enviados = res.data.enviados
            this.listaWapps = [...recibidos, ...enviados]
            this.listaWapps = this.listaWapps.filter(row => row.msg !== null && row.msg !== undefined && row.msg != '')
            this.listaWapps.map(row => row.fecha = dayjs.utc(row.fecha).format('YYYY-MM-DD HH:mm:ss'))
            // this.listaWapps.sort((a, b) => new Date(a.fecha) - new Date(b.fecha)) ; // no hace falta pq ya estan ordenados.
            this.listaChats = []
            // let listaDiferentesChats = Object.values(this.listaWapps.map(({ wapp, fecha }) => ({ wapp, fecha })).reduce((acc, obj) => {
            //   if (!acc[obj.wapp] || obj.fecha > acc[obj.wapp].fecha) {
            //     acc[obj.wapp] = obj;
            //   }
            //   return acc;
            // }, {}));
            let listaDiferentesChats = new Map();
            this.listaWapps.forEach(row => {

              if (listaDiferentesChats.has(row.wapp)) {
                let value = listaDiferentesChats.get(row.wapp);
                if (new Date(row.fecha) > new Date(listaDiferentesChats.get(row.wapp).fecha)) {
                  listaDiferentesChats.set(row.wapp, { fecha: row.fecha, nombres: value.nombres });
                }
              } else {
                let nombres = this.listaDiferentesNombres.get(row.wapp.slice(-10))
                listaDiferentesChats.set(row.wapp, { fecha: row.fecha, nombres: nombres });
              }
            })
            listaDiferentesChats = [...listaDiferentesChats];
            listaDiferentesChats.forEach(row => {
              let cobr = 0;
              let cnt_wapp = row[1].nombres?.length || 1;
              if (this.listaCobrWapps.some(item => item.wapp == row[0].slice(-10))) {
                cobr = 1
              }
              this.listaChats.push({ 'wapp': row[0], 'nombre': row[1].nombres, 'fecha': row[1].fecha, 'cobr': cobr, 'cnt_wapp': cnt_wapp })
            })



            // obtiene los diferentes Chats con la fecha mayor de cada uno. (codigo gentileza de chatGTP.)
            // listaDiferentesChats.forEach(row => {
            //   let cobr = 0
            //   let nombre = this.nombresWapps.find(item => item.wapp == row.wapp.slice(-10))?.nombre || ''
            //   let cnt_wapp = this.nombresWapps.find(item => item.wapp == row.wapp.slice(-10))?.cnt_wapp || 1
            //   if (this.listaCobrWapps.some(item => item.wapp == row.wapp.slice(-10))) {
            //     cobr = 1
            //   }
            //   this.listaChats.push({ 'wapp': row.wapp, 'nombre': nombre, 'fecha': row.fecha, 'cobr': cobr, 'cnt_wapp': cnt_wapp })
            // })
            // this.listaChats.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

          })
      },
      expandChildren(wapp) {
        if (this.wapp == wapp && this.listaWapps_.length > 0) {
          this.listaWapps_ = []
          return
        }
        this.listaWapps_ = this.listaWapps.filter(row => row.wapp.includes(wapp.slice(-10)))
        this.wapp = wapp
        $tbody = document.querySelector('tbody')
        $trwapp = document.getElementById(String(wapp))
        setTimeout(() => {
          let arrayrows = Array.from($tbody.children)
          let children = arrayrows.filter(row => row.classList.contains('children'))
          children = children.reverse()
          for (el of children) {
            $tbody.insertBefore(el, $trwapp.nextSibling)
          }
        }, 1)
      },
      contestarWapp(wapp, nombre) {
        // primero averiguo si no es cobrador
        if (!this.listaCobrWapps.map(row => row.wapp).includes(wapp.slice(-10))) {
          axios.get('/buscador/averiguarsiestasiendorespondido/'+wapp)
          .then(res=>{
            if(res.data.respuesta==0){ // o sea no esta siendo respondido
              console.log("file: gestionarwapps.html:165 ~ contestarWapp ~ res.data.respuesta:", res.data.respuesta)
              axios.get('/buscador/obtenerdniporwappnombre/' + wapp + '/' + nombre)
                .then(res => {
                  dni = res.data.dni
                  window.open('/buscador/interno/' + dni, target = '_blank')
                })
            }else{
              msgError('Este wapp ya esta siendo respondido por otro usuario')
            }
          })
          .catch(err=>msgError(err))
        }
      },
      marcarRespondidoWappOficial(wapp,nombre) {
        axios.get('/buscador/marcarrespondidoporwappoficial/' + wapp+'/'+nombre)
          .then(res => {
            this.getWapps()
          })
          .catch(err=>console.log(err))
      },

    }
  }
</script>
{% endblock %}
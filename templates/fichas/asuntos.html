{% extends "base.html" %} {% block title %}Asuntos{% endblock %} {%
block style %}
<style>
.micard {
    padding: 24px;
    background: white;
    border-radius: 8px;
    box-shadow: 6px 0px 10px gray ;
}
.modal-container{
        width: 100vw;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(0,0,0,0.3);
}
.modal{
    display:flex;
    flex-direction: column;
    position: relative;
}
.btn-close{
    color:purple;
    background-color: white;
    border: none;
    position: absolute;
    top: 0;
    right: 0;
}
[v-cloak]{
	display:none;
}
</style>
{% endblock %} {% block content %}

<div id="app" class="container" v-cloak>
	<p class="title is-1">Asuntos Pendientes</p>
    <div class="buttons">
        <a href="/fichas" class="button is-primary">Fichas</a>
        <a href="/fichas/fechador" class="button is-primary">Fechador</a>
        <a href="/fichas/listado" class="button is-primary">Listado</a>
        <a href="/fichas/cobradores" class="button is-primary">Cobradores</a>
      </div>
	<div class="buttons">
		<button class="button is-primary" @click="filtraAsuntoPorVdor(816)">816</button>
		<button class="button is-primary" @click="filtraAsuntoPorVdor(15)">15</button>
		<button class="button is-info" @click="verTodos()">Todos</button>
		<button class="button is-info" @click="verCompletados()">Completados</button>
		<button class="button is-danger" @click="imprimirAsuntos()">Imprimir</button>


	</div>
	  <table class="table">
		  <thead>
			  <tr>
				  <th>op</th>
				  <th>op</th>
				  <th>op</th>
				  <th>id</th>
				  <th>fecha</th>
				  <th>nombre</th>
				  <th>tipo</th>
				  <th>vdor</th>
				  <th>asunto</th>
				  <th>completado</th>
			  </tr>
		  </thead>
		  <tbody>
			  <tr v-for="asunto in asuntos">
				  <td><button class="button is-small is-danger" @click="deleteAsunto(asunto.id)">Borrar</button></td>
				  <td><button class="button is-small is-info" @click="editAsunto(asunto.id)">Editar</button></td>
				  <td><button class="button is-small is-success" @click="toggleAsuntoCompletado(asunto.id)">Completado</button></td>
				  <td>|asunto.id|</td>
				  <td>|asunto.fecha|</td>
				  <td>|asunto.nombre|</td>
				  <td>|asunto.tipo|</td>
				  <td>|asunto.vdor|</td>
				  <td>|asunto.asunto|</td>
				  <td v-if="asunto.completado"> <span class="tag is-small is-dark">Hecho</span></td>
			  </tr>
		  </tbody>
	  </table>
	  <div :class="verModalAsunto?'modal-container':''">
        <div class=" micard modal" v-show="verModalAsunto">
            <button class="btn-close" @click="verModalAsunto=false"><i class="fa fa-times" aria-hidden="true"></i></button>
            <h1 class="title is-3">Asunto</h1>
			<h3 class="title is-5">|Asunto.nombre|</h3>
            <label for="fecha" class="label">Fecha</label>
            <input type="date" class="input mb-3" v-model="Asunto.fecha" id="fecha" autocomplete="off">
            <label for="p" class="label">Tipo</label>
            <input list="type" id="tipo" class="input mb-3" v-model="Asunto.tipo" autocomplete="off">
                <datalist id="type">
                <option value="Cambio"></option>
                <option value="Devolucion"></option>
                <option value="Venta"></option>
                <option value="Reclamo"></option>
                </datalist>
            <label for="vdor" class="label">Vendedor</label>
            <input type="text" class="input mb-3" v-model="Asunto.vdor" id="vdor" autocomplete="off">
            <label for="asunto" class="label">Asunto</label>
            <input type="text" class="input mb-3" v-model="Asunto.asunto" id="asunto" autocomplete="off">
            <button class="button is-primary" @click="validarAsunto()">Generar</button>
			<input type="hidden" name="csrf_token" ref="token" value="{{ csrf_token() }}"/>
        </div>
    </div>

</div>
{% endblock %} {% block script %}
<script>
	const app = new Vue({
		el: '#app',
		delimiters: ['|', '|'],
		data: {
			asuntos:[],
			asuntos_:[],
			verModalAsunto:false,
			Asunto:{},
		},
		methods: {
			getAsuntos(){
				axios.get('/fichas/getasuntos')
				.then(res=>{
					this.asuntos=res.data.asuntos
					this.asuntos.filter(row=>{row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD')})
					this.asuntos_=this.asuntos
				})
			},
			deleteAsunto(id){
				axios.get('/fichas/deleteasunto/'+id)
				.then(res=>{
					bulmaToast.toast({message:"Asunto borrado",type:"is-success"})
					this.getAsuntos()
				})
			},
			editAsunto(id){
				this.verModalAsunto=true
				this.Asunto = this.asuntos.filter(row=>row.id==id)[0]
			},
			validarAsunto(){
                    if(this.Asunto.fecha!=''&&this.Asunto.tipo!=''&&this.Asunto.vdor!=''&&this.Asunto.asunto!=''){
                        console.log("validado")
                        this.guardarAsunto()
                    }else{
                        bulmaToast.toast({message:"Complete datos necesarios",type:"is-danger"})
                    }
                },
            guardarAsunto(){
                    this.verModalAsunto = false
                    axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
                    axios({
                    method:'POST',
                        url:'/fichas/editarasunto',
                        data:this.Asunto
                        })
                        .then(res=>{
                        bulmaToast.toast({message:"Asunto editado",type: 'is-success'})
                        this.Asunto.tipo=''
                        this.Asunto.vdor=''
                        this.Asunto.asunto=''
						this.getAsuntos()
                        })
                        .catch(error=>{
                        bulmaToast.toast({message:error.request.response, type:'is-danger'})
                        })
                },
			toggleAsuntoCompletado(id){
					axios.get('/fichas/toggleasuntocompletado/'+id)
					.then(res=>{
						bulmaToast.toast({message:"Asunto Completado", type:"is-success"})
						this.getAsuntos()
					})
			},
			filtraAsuntoPorVdor(vdor){
					this.asuntos=this.asuntos_.filter(row=>row.vdor==vdor&&row.completado==0)
			},
			verTodos(){
					this.asuntos=this.asuntos_
			},
			verCompletados(){
					this.asuntos=this.asuntos_.filter(row=>row.completado==1)
			},
			imprimirAsuntos() {
				let ids = [];
				let tbody = document.querySelector("tbody");
				let rowsArray = Array.from(tbody.rows);
				rowsArray.forEach((row) => {
					if (row.classList.contains("selected")) {
						ids.push(row.cells[3].innerHTML);
						//la celda que corresponda a dni OJO
					}
				});

				axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value,
					axios({
						method: "POST",
						url: "/fichas/imprimirasunto",
						responseType: "blob",
						data: ids,
					}).then((res) => {
						let url = window.URL.createObjectURL(res.data);
						window.open(url);
					});
      		},

		},
		created: function(){
			this.getAsuntos()
    },
	});
</script>
{% endblock %}

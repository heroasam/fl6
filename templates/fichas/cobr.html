{% extends "base.html" %}

{% block title %}Cobradores{% endblock %}
{% block style %}
<style>
</style>
{% endblock %}

{% block content %}

<div  class="container" x-data="main()" x-init="getCobrs()">
  <div class="buttons">
    <a href="/fichas" class="button is-primary">Fichas</a>
    <a href="/fichas/fechador" class="button is-primary">Fechador</a>
    <a href="/fichas/listado" class="button is-primary">Listado</a>
    <a href="/fichas/cancelados" class="button is-primary">Cancelados</a>
  </div>
  <p class="title is-1">Gestion de Cobradores</p>

  <div class="columns"><div class="column is-6">
	<div class="grid-buscar  mr-3 mt-2">
      <input type="search" placeholder="Busca: nombre/direccion/dni/tel" class="input text-big" x-model="buscar"
		     @focus="buscar=''" @keyup.enter="filtrarCobr(buscar)" autofocus>
      <button type="button" @click="filtrarCobr(buscar)" class="button is-primary text-big">Buscar</button>
	</div>
  </div></div>
  <button type="button" class="button is-primary" @click="agregarCobr">Agregar Nuevo</button>

  <table id="table" class="table is-narrow nototal noselect">
    <thead>
      <tr>
        <th></th>
        <th></th>
        <th class="numeric">id</th>
        <th>dni</th>
        <th>nombre</th>
        <th>direccion</th>
        <th>telefono</th>
        <th>fechanac</th>
        <th>desde</th>
        <th>activo</th>
        <th>prom</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <template x-for="cobr in listaCobradores_">
        <tr>
  	      <td><i class="fa fa-times" aria-hidden="true" @click="borrarCobr(cobr.id)"></td>
	        <td><i class="fa fa-pencil" aria-hidden="true" @click="editarCobr(cobr.id)"></td>
              <td x-text="cobr.id"></td>
              <td x-text="cobr.dni"></td>
              <td x-text="cobr.nombre"></td>
              <td x-text="cobr.direccion"></td>
              <td x-text="cobr.telefono" style="max-width: 120px;"></td>
              <td x-text="cobr.fechanac" style="min-width: 100px;"></td>
              <td x-text="cobr.desde" style="min-width: 100px;"></td>
              <td><span class="tag is-small is-danger" x-show="cobr.activo" @click="cobr.activo=0">Activo</span></td>
              <td><span class="tag is-small is-warning" x-show="cobr.prom">Prom</span></td>
              <td><button type="button" class="button is-small is-danger is-outlined" @click="toggleActivo(cobr.id)">Activo</button></td>
              <td><button type="button" class="button is-small is-warning is-outlined" @click="toggleProm(cobr.id)">Prom</button></td>
        </tr>
      </template>
    </tbody>
  </table>

  <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}" />
  <!-- modal Bulma -->
  <div class="modal" id="modal-edicion">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Edicion de Barrio</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-edicion')"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="dni">DNI</label>
        <input name="dni" class="input" type="text" x-model="CobradorEditar.dni" />
        <label for="nombre">Nombre</label>
        <input name="nombre" class="input" type="text" x-model="CobradorEditar.nombre" />
        <label for="direccion">Direccion</label>
        <input name="direccion" class="input" type="text" x-model="CobradorEditar.direccion" />
        <label for="telefono">Telefono</label>
        <input name="telefono" class="input" type="text" x-model="CobradorEditar.telefono" />
        <label for="fechanac">Fecha Nacimiento</label>
        <input name="fechanac" class="input" type="date" x-model="CobradorEditar.fechanac" />
        <label for="desde">Desde</label>
        <input name="desde" class="input" type="date" x-model="CobradorEditar.desde" />
        <label for="activo">Activo</label>
        <input name="activo" class="input" type="text" x-model="CobradorEditar.activo" />
        <label for="prom">Promotor</label>
        <input name="prom" class="input" type="text" x-model="CobradorEditar.prom" />

      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" @click="guardarEdicion()">Editar</button>
        <button class="button" @click="toggleModal('modal-edicion')">Cancelar</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="modal-add">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Agregar Barrio</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-add')"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="dni">DNI</label>
        <input name="dni" class="input" type="text" x-model="Cobrador.dni" />
        <label for="nombre">Nombre</label>
        <input name="nombre" class="input" type="text" x-model="Cobrador.nombre" />
        <label for="direccion">Direccion</label>
        <input name="direccion" class="input" type="text" x-model="Cobrador.direccion" />
        <label for="telefono">Telefono</label>
        <input name="telefono" class="input" type="text" x-model="Cobrador.telefono" />
        <label for="fechanac">Fecha Nacimiento</label>
        <input name="fechanac" class="input" type="date" x-model="Cobrador.fechanac" />
        <label for="desde">Desde</label>
        <input name="desde" class="input" type="date" x-model="Cobrador.desde" />
        <label for="activo">Activo</label>
        <input name="activo" class="input" type="text" x-model="Cobrador.activo" />
        <label for="prom">Promotor</label>
        <input name="prom" class="input" type="text" x-model="Cobrador.prom" />

      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" @click="guardarCobr()">Agregar</button>
        <button class="button" @click="toggleModal('modal-add')">Cancelar</button>
      </footer>
    </div>
  </div>

</div>

</div>
{% endblock %}

{% block script %}
<script>
 function main(){
     return{
         listaCobradores:[],
         listaCobradores_:[],
	     Cobrador:{},
	     CobradorEditar:{},
         buscar:'',
         getCobrs(){
             axios.get('/fichas/getfullcobradores')
		          .then(res=>{
                      this.listaCobradores = res.data.cobradores
                      this.listaCobradores.forEach(row => {
			              if(row.fechanac!==null) row.fechanac=dayjs.utc(row.fechanac).format('YYYY-MM-DD')
			              if(row.desde!==null) row.desde=dayjs.utc(row.desde).format('YYYY-MM-DD')
                      });
                      this.listaCobradores_=this.listaCobradores
		          })
         },
         borrarCobr(id){
	         Swal.fire({
                 title: 'Â¿Esta seguro?',
                 text: `Se borrara el cobrador ${id}`,
                 icon: 'warning',
                 showCancelButton: true,
                 confirmButtonColor: '#3085d6',
                 cancelButtonColor: '#d33',
                 confirmButtonText: 'Si, borrarlo!'
             }).then((result) => {
                 if (result.isConfirmed) {
                     axios.get('/fichas/borrarcobrador/'+id)
                          .then(res=>{
                              msgSuccess('Borrado!','El cobrador ha sido borrado')
                              this.getCobrs()})
                          .catch(error=>msgError(error.request.response))
             }})
         },
         agregarCobr(){
	         toggleModal('modal-add')
         },
	     guardarCobr(){
	         toggleModal('modal-add')
	         this.Cobrador.id=''
	         axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/fichas/guardarcobrador',this.Cobrador)
								                                 .then(res=>{
								                                     this.getCobrs()
								                                     msgSuccess('Cobrador agregado con exito')
								                                 })
								                                 .catch(error=>{
								                                     msgError('No se pudo hacer agregar el cobrador')
								                                 })
	     },
         editarCobr(id){
	         toggleModal('modal-edicion')
	         this.CobradorEditar = this.listaCobradores.filter(row=>row.id==id)[0]
         },
         guardarEdicion(){
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/fichas/guardarcobrador',this.CobradorEditar)
								                                 .then(res=>{
								                                     toggleModal('modal-edicion')
								                                     this.getCobrs()
								                                     msgSuccess('Cobrador editado con exito')
								                                 })
								                                 .catch(error=>{
								                                     msgError('No se pudo hacer la edicion')
								                                 })
         },
         toggleActivo(id){
             axios.get('/fichas/toggleactivo/'+id)
		          .then(res=>{
                      this.getCobrs()
		          })
         },
         toggleProm(id){
             axios.get('/fichas/toggleprom/'+id)
		          .then(res=>{
                      this.getCobrs()
		          })
         },
         filtrarCobr(buscar){
             this.listaCobradores_=this.listaCobradores.filter(row=>{
                 return (row.dni+row.nombre+row.direccion+row.telefono).toLocaleLowerCase().includes(buscar.toLocaleLowerCase())
             })
         },
 }}
</script>
{% endblock %}

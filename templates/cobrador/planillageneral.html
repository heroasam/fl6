{% extends "base.html" %}

{% block title %}Rendiciones{% endblock %}
{% block style %}
<style>
</style>
{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="getCobradores()">

    <p class="title is-1">Rendiciones Cobradores</p>
    <div class="columns">
        <div class="column is-6">
            <div class="buttons" id="btnCobr">
                <template x-for="cobr in listaCobradores">
                    <button class="button is-info" @click="getCobrosCobr(cobr);limpiarToggles();
                           $event.target.classList.toggle('is-warning')" x-text="cobr"></button>
                </template>
            </div>
            <div class="is-flex-direction-row">
                <div class="xtags has-addons m-0" x-show="totalRendir">
                    <span class="tag is-small is-black m-0">Cobrado</span>
                    <span class="tag is-small is-light m-0" x-text="'$'+totalCobrado"></span>
                </div>
                <div class="xtags has-addons m-0" x-show="totalRendir">
                    <span class="tag is-small is-success m-0">Comision</span>
                    <span class="tag is-small is-light m-0" x-text="'$'+totalComision"></span>
                </div>
                <div class="xtags has-addons m-0" x-show="totalRendir">
                    <span class="tag is-small is-danger m-0">Rendir</span>
                    <span class="tag is-small is-light m-0" x-text="'$'+totalRendir"></span>
                </div>
            </div>
            <hr>
            <table class="table is-narrow" id="planillas">
                <thead>
                    <tr>
                        <th></th>
                        <th>fecha</th>
                        <th>cnt</th>
                        <th class="sumar">cobrado</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="item in listaFechas">
                        <tr :id="item.fecha">
                            <td><span class="icon is-small"><i class="fa fa-plus-square-o" aria-hidden="true"
                                        @click="expandChildren(item.fecha)"></td>
                            <td x-text="item.fecha"></td>
                            <td x-text="item.cnt"></td>
                            <td x-text="item.cobrado" class="pesos"></td>
                        </tr>
                    </template>
                    <template x-for="item in listaCobros_">
                        <tr class="children">
                            <td></td>
                            <td x-text="item.idvta"></td>
                            <td x-text="item.imp" class="pesos"></td>
                            <td x-text="item.rbo" x-show="item.rbo"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <button class="button is-danger" @click="validarPagado()">Pagado</button>
            <button class="button is-danger" @click="validarPagadoSeleccionados()">Pagado dias
                seleccionados</button>
            <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}" />

        </div>


    </div>
    {% endblock %}

    {% block script %}
    <script>
        function main() {
            return {
                listaFechas: [],
                listaCobros: [],
                listaCobros_: [],
                listaCobradores: [],
                totalRendir: 0,
                totalCobrado: 0,
                totalComision: 0,
                cobrador: '',
                Procesar: {},
                getCobradores() {
                    axios.get('/cobrador/getcobradores')
                        .then(res => {
                            this.listaCobradores = res.data.cobradores;
                            console.log(this.listaCobradores);
                        })
                },
                getCobrosCobr(cobr) {
                    limpiarTabla('planillas')
                    this.listaCobros_ = []
                    this.cobrador = cobr
                    axios.get('/cobrador/getcobroscobr/' + cobr)
                        .then(res => {
                            this.listaCobros = res.data.listacobros
                            this.listaCobros.map(row => row.fecha = dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                            this.listaFechas = res.data.listafechas
                            this.listaFechas.map(row => row.fecha = dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                            this.totalCobrado = this.listaFechas.reduce((a, b) => parseInt(a) + parseInt(b.cobrado), 0);
                            this.totalComision = (this.totalCobrado * 0.15).toFixed();
                            this.totalRendir = this.totalCobrado - this.totalComision;
                        })
                },
                limpiarToggles() {
                    $btnCobr = document.getElementById('btnCobr')
                    Array.from($btnCobr.children).slice(1).forEach(btn => {
                        btn.classList.remove('is-warning')
                    })
                },
                expandChildren(fecha) {
                    if (this.fecha == fecha && this.listaCobros_.length > 0) {
                        this.listaCobros_ = []
                        return
                    }
                    this.listaCobros_ = this.listaCobros.filter(row => row.fecha == fecha)
                    this.fecha = fecha
                    setTimeout(() => {
                        $tbody = document.querySelector('tbody')
                        $trfecha = document.getElementById(fecha)
                        let arrayrows = Array.from($tbody.children)
                        let children = arrayrows.filter(row => row.classList.contains('children'))
                        children = children.reverse()
                        for (el of children) {
                            $tbody.insertBefore(el, $trfecha.nextSibling)
                        }
                    }, 10)
                },
                cuentaSeleccionados() {
                    let arraySeleccionados = []
                    const $tbody = document.querySelector("tbody");
                    arrayRows = Array.from($tbody.children);
                    arrayRows.forEach((row) => {
                        if (row.classList.contains('is-selected')) {
                            arraySeleccionados.push(row.cells[1].innerHTML)
                            //OJO la celda de las fechas
                        }
                    })
                    return arraySeleccionados
                },
                validarPagado() {
                    let cobr = this.cobrador;
                    Swal.fire({
                        title: '¿Esta seguro?',
                        text: `Se marcara como pagadas las Cobros del cobrador ${cobr}`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, Marcarlas!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            axios.get('/cobrador/marcarpagadas/' + cobr)
                                .then(res => {
                                    msgSuccess('Marcado!', 'El cobrador ha cobrado lo que tenia hasta el momento y se validaran los pagos.')
                                    this.getCobrosCobr(cobr)
                                })
                                .catch(error => msgError('No se pudo procesar. Hubo un error.'))
                        }
                    })
                },
                validarPagadoSeleccionados() {
                    let cobr = this.cobrador;
                    console.log(cobr, this.cuentaSeleccionados());
                    this.Procesar.fechas = this.cuentaSeleccionados()
                    this.Procesar.cobr = cobr
                    console.log('procesar', this.Procesar);
                    axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value;
                    Swal.fire({
                        title: '¿Esta seguro?',
                        text: `Se marcara como pagadas las comisiones del cobrador de los dias seleccionados, y se validaran los pagos.`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, Marcarlas!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            axios.post('/cobrador/marcarpagadasseleccionados', this.Procesar)
                                .then(res => {
                                    msgSuccess('Marcado!', 'El cobrador cobro los dias seleccionados')
                                    this.getCobrosCobr(cobr)
                                    limpiarTabla('planillas')
                                })
                                .catch(error => msgError('No se pudo procesar. Hubo un error.'))
                        }
                    })
                },
            }
        }
    </script>
    {% endblock %}
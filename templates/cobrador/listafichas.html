{% extends "base.html" %}

{% block title %}Lista Fichas{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="getListadoFichas();setInterval(()=>{getListadoFichas()},600000)">
  <p class="title is-1">Lista Fichas</p>
  <div>
    <template x-for="zona in listaZonas">
      <button class="button is-small is-primary" x-text="zona" @click="filtraPorZona(zona)"></button>
    </template>
  </div>
  <div>
    <template x-for="calle in listaCalles">
      <button class="button is-small is-black" x-text="calle" @click="filtraPorCalle(calle)"></button>
    </template>
  </div>
  <table class="table table-striped " id="table" x-show="verCard==false">
    <thead>
      <tr>
        <th></th>
        <th>nombre</th>
        <th>calle</th>
        <th>num</th>
        <th>horario</th>
        <th>comentarios</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="ficha in listaFichas_">
        <tr>
          <td><span class="tag is-small is-danger" @click="abrirCliente(ficha.id)">Ir</span></td>
          <td x-text="ficha.nombre"></td>
          <td x-text="ficha.calle"></td>
          <td x-text="ficha.num"></td>
          <td x-text="ficha.horarios"></td>
          <td x-text="ficha.comentarios"></td>
        </tr>
      </template>
    </tbody>
  </table>

  <!-- verCard Ficha -->
  <div class="card box" x-show="verCard==true">
    <h1 class="title is-4" x-text="Ficha.nombre"></h1>
    <div class="flex-between">
      <h2 class="title is-5" x-text="Ficha.calle+' '+Ficha.num"></h2>
                  <a class="button is-black is-small" :href="'https://www.google.com/maps/place/'+Ficha.calle+'+'+Ficha.num+',+C%C3%B3rdoba'">Maps</a>
    </div>
    <h4 class="subtitle is-6" x-text="Ficha.acla" x-show="Ficha.acla"></h4>
    <div class="flex-between">
      <h2 class="title is-5 no-mb" x-text="Ficha.wapp?Ficha.wapp:Ficha.tel"></h2>
            <a x-bind:href=`https://wa.me/549${Ficha.wapp}?text=''` class="tag is-success is-small"
               target="blank" style="text-decoration: none;" x-show="Ficha.wapp">Whats</a>
            <span class="tag is-small is-info pointer ml-5" @click="hacerLlamada(Ficha.wapp?Ficha.wapp:Ficha.tel)">Llamar</span>
            <span class="tag is-small is-primary pointer ml-5" @click="editarWapp">Editar</span>
    </div>
    <h4 class="subtitle is-6" x-text="Ficha.barrio"></h4>
    <hr/>
    <h4 class="title is-6 no-mb" x-text="Ficha.horarios" x-show="Ficha.horarios"></h4>
    <h4 class="title is-6 no-mb" x-text="Ficha.comentarios" x-show="Ficha.comentarios"></h4>
    <div class="buttons" x-show="!Ficha.idvta">
      <button class="button is-small is-info" @click="fecharFicha(Ficha.id)" id="buttonFecharFicha">Fechar</button>
      <button class="button is-small is-warning" @click="noEstabaFicha()" id="buttonNoestabaFicha">No Estaba</button>
      <button class="button is-small is-primary" @click="mudoFicha()" id="buttonMudoFicha">Mudo</button>
      <button class="button is-small is-black" @click="fallecioFicha()" id="buttonFallecioFicha">Fallecio</button>
    </div>
  </div>


  <!-- bulma-modal fechar-ficha -->
  <div class="modal" id="modal-fechar-ficha">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Fechar ficha</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-fechar-ficha')"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="idfecha">Nueva Fecha a Visitar</label>
        <input type="date" class="input mb-3" x-model="Ficha.pmovto" id="idfecha">
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" @click="guardarfichaFechado()">Guardar</button>
        <button class="button" @click="toggleModal('modal-fechar-ficha')">Cancelar</button>
      </footer>
    </div>
  </div>
  <!-- bulma-modal edicion-wapp -->
  <div class="modal" id="modal-edicion-wapp">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Editar WhatsApp</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-edicion-wapp')"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="idwapp">WhatsApp</label>
        <input type="text" class="input mb-3" x-model="Ficha.wapp" id="idwapp">
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" @click="guardarWapp">Guardar</button>
        <button class="button" @click="toggleModal('modal-edicion-wapp')">Cancelar</button>
      </footer>
    </div>
    <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
  </div>

</div>
{% endblock %}
{% block script %}
<script>
 function main(){
     return{
         listaZonas:[],
         listaFichas:[],
         listaFichas_:[],
         listaCalles:[],
         verCard:false,
         Ficha:{},
         getListadoFichas(){
             axios.get('/cobrador/getlistadofichas')
                  .then(res=>{
                      this.listaZonas = res.data.zonas
                      this.listaFichas = res.data.fichas
                      this.listaFichas_ = this.listaFichas
                      this.listaFichas_.sort((a,b)=>{
                          let s1 = a.nombre.toLowerCase(),
                              s2 = b.nombre.toLowerCase()

                          if(s1>s2) return 1
                          if(s1<s2) return -1
                          if(s1==s2) return 0
                      })
                  })
         },
         filtraPorZona(zona){
             this.listaFichas_=this.listaFichas.filter(row=>row.zona==zona)
             this.listaCalles=Array.from(new Set(this.listaFichas_.map(row=>row.calle)))
             let callesCnt = []
             this.listaCalles.forEach(calle=>{
                 let cnt = this.listaFichas_.filter(row=>row.calle==calle).length
                 callesCnt.push(`${calle}-${cnt}`);
             })
             this.listaCalles = callesCnt.sort()
             this.listaFichas_.sort((a,b)=>{
                 let s1 = a.nombre.toLowerCase(),
                     s2 = b.nombre.toLowerCase()

                 if(s1>s2) return 1
                 if(s1<s2) return -1
                 if(s1==s2) return 0
             })
         },
         filtraPorCalle(calle){
             pattern = /[^-]*/gi;
             calle = pattern.exec(calle);
             this.listaFichas_=this.listaFichas.filter(row=>row.calle==calle)
             this.verCard = false;
             this.listaFichas_.sort((a,b)=>{
                 let s1 = a.nombre.toLowerCase(),
                     s2 = b.nombre.toLowerCase()

                 if(s1>s2) return 1
                 if(s1<s2) return -1
                 if(s1==s2) return 0
             })
         },
         abrirCliente(id){
             idButton = document.getElementById('buttonFecharFicha')
             idButton.disabled=false
             idButton = document.getElementById('buttonNoestabaFicha')
             idButton.disabled=false
             idButton = document.getElementById('buttonMudoFicha')
             idButton.disabled=false
             idButton = document.getElementById('buttonFallecioFicha')
             idButton.disabled=false
             this.Ficha = this.listaFichas.filter(row=>row.id==id)[0];
             this.verCard = true;
          },
         fecharFicha(idcliente){
             idButton = document.getElementById('buttonFecharFicha')
             idButton.disabled=true
             toggleModal("modal-fechar-ficha");
             this.verCard = false;
         },
         guardarfichaFechado(){
             toggleModal("modal-fechar-ficha");
             axios.get('/cobrador/fecharficha/'+this.Ficha.id+'/'+this.Ficha.pmovto)
                  .then(res=>{
                      this.getListadoFichas()
                      msgSuccess("Ficha fechada correctamente")
             })
         },
         editarWapp(){
             toggleModal("modal-edicion-wapp");
         },
         guardarWapp(){
             console.log( this.Ficha)
             // nueva ruta para /vendedor/editarwapp
             // /uQ3gisetQ8v0n6tw81ORnpL1s
             this.Ficha.idcliente = this.Ficha.id
             toggleModal("modal-edicion-wapp");
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value;
             axios.post('/uQ3gisetQ8v0n6tw81ORnpL1s',this.Ficha)
                                                                 .then(res=>{
                                                                     msgSuccess('WhatsApp editado correctamente');
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError('Error. No se hizo la edicion');
                                                                 })
         },
         hacerLlamada(tel){
             re = /[0-9]*/;
             tel = re.exec(tel)[0];
             window.location.href = 'tel:' + tel;
         },
         noEstabaFicha(){
             idButton = document.getElementById('buttonNoestabaFicha')
             idButton.disabled=true
             axios.get('/cobrador/noestabaficha/'+this.Ficha.id)
             this.verCard = false;
             msgSuccess("Marcado como no estaba")
         },
          mudoFicha(){
             Swal.fire({
                 title: '¿Esta seguro?',
                 text: `Se pondra como mudado el cliente`,
                 icon: 'warning',
                 showCancelButton: true,
                 confirmButtonColor: '#3085d6',
                 cancelButtonColor: '#d33',
                 confirmButtonText: 'Si, ponerlo!'
             }).then((result) => {
                 if (result.isConfirmed) {
                     idButton = document.getElementById('buttonMudoFicha')
                     idButton.disabled=true
                     axios.get('/cobrador/mudoficha/'+this.Ficha.id)
                         .then(res=>{
                             msgSuccess('Mudado informado correctamente');
                             this.getListadoFichas()
                             this.verCard = false;
                         })
                         .catch(error=>{
                             msgError('Hubo un error. No se pudo procesar');
                         })
                 }})
         },
         fallecioFicha(){
              Swal.fire({
                  title: '¿Esta seguro?',
                  text: `Se pondra como fallecido el cliente`,
                  icon: 'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#3085d6',
                  cancelButtonColor: '#d33',
                  confirmButtonText: 'Si, ponerlo!'
              }).then((result) => {
                  if (result.isConfirmed) {
                      idButton = document.getElementById('buttonFallecioFicha')
                      idButton.disabled=true
                      axios.get('/cobrador/fallecioficha/'+this.Ficha.id)
                          .then(res=>{
                              msgSuccess('Fallecimiento informado correctamente');
                              this.getListadoFichas();
                              this.verCard = false;
                          })
                          .catch(error=>{
                              msgError('Hubo un error. No se pudo procesar');
                          })
              }})
         },

     }
 }
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Lista Datos{% endblock %}

{% block content %}

<div class="container" x-data="main()" x-init="getListadoDatosVendedor()">


  <p class="title is-1">Lista Datos</p>

  <div>
    <template x-for="zona in listaZonasDatos">
      <button class="button is-small is-primary" x-text="zona" @click="filtraPorZona(zona)"></button>
    </template>
  </div>
  <table class="table table-striped " id="table" x-show="verCard==false">
    <thead>
      <tr>
        <th>fecha</th>
        <th>nombre</th>
        <th>calle</th>
        <th>num</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <template x-for="dato in listadoDatos_">
        <tr>
          <td x-text="dato.fecha_visitar"></td>
          <td x-text="dato.nombre"></td>
          <td x-text="dato.calle"></td>
          <td x-text="dato.num"></td>
          <td><button class="button is-small is-danger" @click="abrirCliente(dato.idcliente)">Ir</button></td>
          <td><span class="tag is-small" x-text="dato.resultado==1?'Vendido':(dato.resultado==0?'Anulado':(dato.resultado==2?'Rechazado':'Pendiente'))"
                    :class="dato.resultado==1?'is-success':(dato.resultado==0?'is-danger':(dato.resultado==2?'is-warning':'is-info' ))"></span></td>

        </tr>
      </template>
    </tbody>
  </table>

  <!-- verCard Dato -->
  <div class="card box" x-show="verCard==true">
    <h1 class="title is-4" x-text="Dato.nombre"></h1>
    <h2 class="title is-5" x-text="Dato.calle+' '+Dato.num"></h2>
    <h4 class="subtitle is-6" x-text="Dato.acla" x-show="Dato.acla"></h4>
    <div class="flex-between">
      <h2 class="title is-5 no-mb" x-text="Dato.wapp?Dato.wapp:Dato.tel"></h2>
      <span class="tag is-small is-success pointer ml-5" @click="editarWapp">Editar</span>
    </div>
    <h4 class="subtitle is-6" x-text="Dato.barrio"></h4>
    <hr/>
    <h2 class="title is-4" x-text="'Cuota Maxima $'+Dato.cuota_maxima"></h2>

  </div>

   <!-- bulma-modal editar-dato  -->
  <div class="modal" id="modal-editar-dato">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Editar Dato</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-editar-dato')"></button>
        <input type="hidden" name="csrf_token" x-ref="token" value="{{ csrf_token() }}"/>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="idfecha">Fecha</label>
        <input type="date" class="input mb-3" x-model="Datos.fecha" id="idfecha"
               :class="darkTheme?'input-dark':''" >
        <label for="idfechavisitar">Fecha a Visitar (opcional)</label>
        <input type="date" class="input mb-3" x-model="Datos.fecha_visitar" id="idfechavisitar"
               :class="darkTheme?'input-dark':''" >
        <label for="art" class="label">Articulo (opcional)</label>
        <input type="text" class="input mb-3" x-model="Datos.art" id="art" autocomplete="off"
               :class="darkTheme?'input-dark':''" >
        <label for="horarios" class="label">Horarios (opcional)</label>
        <input type="text" class="input mb-3" x-model="Datos.horarios" id="horarios" autocomplete="off"
               :class="darkTheme?'input-dark':''" >
        <label for="comentarios" class="label">Comentarios (opcional)</label>
        <input type="text" class="input mb-3" x-model="Datos.comentarios" id="comentarios" autocomplete="off"
               :class="darkTheme?'input-dark':''" >
        <label for="cuota" class="label">Cuota Maxima</label>
        <input type="text" class="input mb-3" x-model="Datos.cuota_maxima" id="cuota" autocomplete="off"
               :class="darkTheme?'input-dark':''" >
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" @click="guardarDato">Editar</button>
        <button class="button" @click="toggleModal('modal-editar-dato')">Cancelar</button>
      </footer>
    </div>
  </div>
   <!-- bulma-modal edicion-wapp -->
  <div class="modal" id="modal-edicion-wapp">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Editar WhatsApp</p>
        <button class="delete" aria-label="close" @click="toggleModal('modal-edicion-wapp')"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <label for="idwapp">WhatsApp</label>
        <input type="text" class="input mb-3" x-model="Dato.wapp" id="idwapp">
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary" @click="guardarWapp">Guardar</button>
        <button class="button" @click="toggleModal('modal-edicion-wapp')">Cancelar</button>
      </footer>
    </div>
  </div>

</div>
{% endblock %}
{% block script %}
<script>
 function main(){
     return{
         listadoDatos:[],
         listadoDatos_:[],
         listaZonasDatos:[],
         Dato:{},
         Datos:{},
         cuota_basica:'',
         verCard:false,
         getListadoDatosVendedor(){
             axios.get('/vendedor/getlistadodatosvendedor')
                  .then(res=>{
                      this.listadoDatos = res.data.listadodatos
                      this.listadoDatos.map(row=>row.fecha=dayjs.utc(row.fecha).format('YYYY-MM-DD'))
                      this.listadoDatos.map(row=>row.fecha_visitar=dayjs.utc(row.fecha_visitar).format('MM-DD'))
                      this.listadoDatos_ = this.listadoDatos
                      this.getListaZonas()
                  })
         },
         getListaZonas(){
             let arrayZonas = this.listadoDatos.map(row=>row.zona)
             let zonaDatos = {}
             arrayZonas.forEach(item=>{
                 if (item in zonaDatos){
                     zonaDatos[item] += 1
                 }else{
                     zonaDatos[item] = 1

                 }
             })
             for (let item in zonaDatos){
                 this.listaZonasDatos.push(`${item}-${zonaDatos[item]}`)
             }
         },
         editarDato(id){
             this.Datos = this.listadoDatos.filter(row=>row.id==id)[0]
             toggleModal("modal-editar-dato")
         },
         guardarDato(){
             toggleModal("modal-editar-dato")
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/buscador/editardato',this.Datos)
                                                                 .then(res=>{
                                                                     msgSuccess('Dato editado con exito.')
                                                                     this.getListadoDatos()
                                                                 })
                                                                 .catch(error=>{
                                                                     msgError('Hubo un error. El dato no se edito.')
             })
         },
         filtraDatosPorVendedor(vdor){
             this.listadoDatos_ = this.listadoDatos.filter(row=>row.vendedor==vdor)
         },
         filtraDatosPorStatus(status){
             switch(status){
                 case 'vendidos':
                     this.listadoDatos_ = this.listadoDatos.filter(row=>row.resultado==1)
                     break
                 case 'anulados':
                     this.listadoDatos_ = this.listadoDatos.filter(row=>row.resultado==0)
                     break
                 case 'pendientes':
                     this.listadoDatos_ = this.listadoDatos.filter(row=>row.resultado==null)
                     break
                 case 'todos':
                     this.listadoDatos_ = this.listadoDatos
                     break
             }
         },
         filtraPorZona(zona){
             // la zona me viene en formato jid1-5 por eso tengo que limpiar
             pattern = /[^-]*/gi
             zona = pattern.exec(zona)
             this.listadoDatos_ = this.listadoDatos.filter(row=>row.zona==zona)
             this.verCard = false
         },
         abrirCliente(id){
             this.Dato = this.listadoDatos.filter(row=>row.idcliente==id)[0]
             this.verCard = true
         },
         editarWapp(){
             toggleModal("modal-edicion-wapp")
         },
         guardarWapp(){
             toggleModal("modal-edicion-wapp")
             axios.defaults.headers.common['X-CSRF-TOKEN'] = this.$refs.token.value
             axios.post('/vendedor/editarwapp',this.Dato)
                                                                 .then(res=>{
                      msgSuccess('WhatsApp editado correctamente')
             })
                  .catch(error=>{
                      msgerror('Error. No se hizo la edicion')
             })
         },

     }
 }
</script>
{% endblock %}
